!function(){"use strict";class GameConfig{constructor(){}static init(){Laya.ClassUtils.regClass}}GameConfig.width=750,GameConfig.height=1624,GameConfig.scaleMode="showall",GameConfig.screenMode="none",GameConfig.alignV="top",GameConfig.alignH="left",GameConfig.startScene="Game.scene",GameConfig.sceneRoot="",GameConfig.debug=!1,GameConfig.stat=!1,GameConfig.physicsDebug=!1,GameConfig.exportSceneToJson=!0,GameConfig.init();class PrepareItem{constructor(name=""){this._resList=[],this._name=name}onInit(){}complete(){this._complete=!0,this.completeHandler.run()}init(){this.onInit()}start(){throw Error("must be overrided")}dispose(){}get progress(){return 1}}class UrlManager extends Laya.EventDispatcher{constructor(){super(),this.urlData=null,this.window=Laya.Browser.window}static get instance(){return UrlManager._instance||(UrlManager._instance=new UrlManager)}geturlAlldata(){return this.window.location.href}getUrlProtocol(){return this.window.location.protocol}getUrlParams(name=null){let urlobj={},url=this.window.location.search;if(1==url.indexOf("?"))return!1;var nameres,queryString=url?url.split("?")[1]:url.slice(1);url=queryString.split("&"),name=name||"";for(let i=0;i<url.length;i++){let info=url[i].split("=");urlobj[info[0]]=decodeURI(info[1])}return name?urlobj[name]&&(nameres=urlobj[name]):nameres=urlobj,this.urlData||(this.urlData=urlobj),nameres}}class Player{constructor(){this.nickname="",this.account="",this.cards={},this.level=1,this.assistLevel=0,this.hp=0,this.star=0,this.prize_list_status=0,this.game_prize_status=0,this.card_prize_status=0,this.life_status="",this.code="",this.token=""}}class Global{}Global.domain="http://mwxllk.sanguosha.com/gamexxl_new_202101/",Global.plat_api="http://mwx.sanguosha.com/api/v2",Global.gameServer="ws://116.62.121.246:8800",Global.resVersion="1.0.0",Global.TWEENTIME=300,Global.CLEARTWEENTIME=375,Global.MOVEDOWNTIME=130,Global.USEPROPSTIME=375,Global.colorMaxNum=5,Global.maxLevel=60,Global.maxHp=5,Global.isOffline=!1,Global.debug_log=!1,Global.scale=.85,Global.boardHeight=396,Global.allowForceChange=1,Global.tips=["试试向四周拖拽火箭吧！","火箭消除整行或整列。","炸药消除一个小区域。","陀螺消除所有相同的障碍物。","从拖动到成功消除算一步哦。","试试连续消除吧，可以节省步数","有的障碍物无法移动，试试周围吧！","有的障碍物需要消除多次，耐心点吧！","玉佩落到最底部才能消除哦。","道具可以相互组合，想好策略吧！","除了拖拽，双击也可以使用道具哦。"];class Log{}var ItemType;Log.log=((prefix,msg)=>{msg?Global.debug_log&&console.log(`[${Log.getTimeHMS()}][${prefix}]`,msg):Global.debug_log&&console.log(`[${Log.getTimeHMS()}][${prefix}]`)}),Log.getTimeHMS=(()=>{const date=new Date;return`${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}--\x3e`}),function(ItemType){ItemType[ItemType.DEAD=-1]="DEAD",ItemType[ItemType.SPACE=0]="SPACE",ItemType[ItemType.NORMAL=1]="NORMAL",ItemType[ItemType.LOCKED=2]="LOCKED",ItemType[ItemType.SUGER=3]="SUGER",ItemType[ItemType.ICE=4]="ICE",ItemType[ItemType.BOX=5]="BOX",ItemType[ItemType.DONUT=6]="DONUT",ItemType[ItemType.CHERRY=7]="CHERRY",ItemType[ItemType.BISCUIT=8]="BISCUIT",ItemType[ItemType.WALNUT=9]="WALNUT",ItemType[ItemType.HENG=101]="HENG",ItemType[ItemType.SHU=102]="SHU",ItemType[ItemType.BOMB=103]="BOMB",ItemType[ItemType.BALL=104]="BALL",ItemType[ItemType.PLANE=105]="PLANE",ItemType[ItemType.ROCKET_ROCKET=201]="ROCKET_ROCKET",ItemType[ItemType.ROCKET_BOMB=202]="ROCKET_BOMB",ItemType[ItemType.ROCKET_BALL=203]="ROCKET_BALL",ItemType[ItemType.BOMB_BOMB=204]="BOMB_BOMB",ItemType[ItemType.BOMB_BALL=205]="BOMB_BALL",ItemType[ItemType.BALL_BALL=206]="BALL_BALL",ItemType[ItemType.PLANE_H_ROCKET=207]="PLANE_H_ROCKET",ItemType[ItemType.PLANE_S_ROCKET=208]="PLANE_S_ROCKET",ItemType[ItemType.PLANE_BOMB=209]="PLANE_BOMB",ItemType[ItemType.PLANE_BALL=210]="PLANE_BALL",ItemType[ItemType.PLANE_PLANE=211]="PLANE_PLANE"}(ItemType||(ItemType={}));class PlayFromUtil{}PlayFromUtil.isWXPlatform=(()=>!(!Laya.Browser.onWeiXin&&!Laya.Browser.onMiniGame));class ResConfig{static getLevelJson(levelId){return"level/"+levelId+".json"}static getSoundURL(path,native=!0){return this.getResourceURL("sound/"+path,native)}static getAtlasURL(path,native=!0){return this.getResourceURL("atlas/"+path,native)}static getSpineURL(path,native=!0){return this.getResourceURL("spine/"+path,native)}static getResourceURL(subpath,native=!0){return ResConfig.getURL("res/"+subpath,native)}static getBoardURL(subpath,native=!0){return ResConfig.getURL("board/"+subpath,native)}static getDlgURL(subpath,native=!0){return ResConfig.getURL("dlg/"+subpath,native)}static getShapeImgUrl(type,hp){switch(type){case ItemType.LOCKED:return ResConfig.IMGURL+"locked"+hp+".png";case ItemType.SUGER:return ResConfig.IMGURL+"suger"+hp+".png";case ItemType.ICE:return ResConfig.IMGURL+"ice"+hp+".png";case ItemType.CHERRY:return ResConfig.IMGURL+"suger"+(hp+1)+".png";default:return""}}static getItemUrl(type,hp,color){switch(type){case ItemType.DEAD:case ItemType.SPACE:return null;case ItemType.DONUT:return ResConfig.IMGURL+"donut.png";case ItemType.BOX:return ResConfig.IMGURL+"box"+hp+".png";case ItemType.CHERRY:return ResConfig.IMGURL+"cherry0.png";case ItemType.BISCUIT:return ResConfig.IMGURL+"biscuit"+hp+".png";case ItemType.WALNUT:return ResConfig.IMGURL+"walnut"+hp+".png";case ItemType.HENG:return ResConfig.IMGURL+"heng_rocket.png";case ItemType.SHU:return ResConfig.IMGURL+"shu_rocket.png";case ItemType.BOMB:return ResConfig.IMGURL+"bomb.png";case ItemType.BALL:return ResConfig.IMGURL+"ball.png";case ItemType.PLANE:return ResConfig.IMGURL+"plane.png";default:return ResConfig.IMGURL+color+".png"}}}ResConfig.IMGURL="icon/",ResConfig.getURL=((path,native=!1)=>PlayFromUtil.isWXPlatform()?native||0==Global.domain.length||"0"==Global.resVersion?path:Global.domain+"/"+path:native||0==Global.domain.length?path:Global.domain+"/"+path);class Utils{static unique(arr){if(arr.length<1)return[];arr.sort();let tempArr=[arr[0]];for(let i=1;i<arr.length;i++)arr[i]!=arr[i-1]&&tempArr.push(arr[i]);return tempArr}static getTime(time){let hours=Math.floor(time/3600),minutes=Math.floor((time-3600*hours)/60),seconds=time-3600*hours-60*minutes;return(hours<10?"0"+hours:""+hours)+":"+(minutes<10?"0"+minutes:""+minutes)+":"+(seconds<10?"0"+seconds:""+seconds)}static getDay(){let date=new Date,year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();return parseInt(""+year+(month<10?"0"+month:""+month)+(day<10?"0"+day:""+day))}static getRotationWithTwoPoint(x1,y1,x2,y2){let tempX=x2-x1,temp=(y2-y1)/tempX;return tempX<0?Math.floor(180*Math.atan(temp)/Math.PI+180):Math.floor(180*Math.atan(temp)/Math.PI)}static back(){Global.isOffline||(window.location.href="http://mwx.sanguosha.com/ddp_202101/")}static addEdge(caller,side,corner,length=3){let img=new Laya.Image(ResConfig.getBoardURL("edge.jpg")),tempW=0;switch(1==length?(tempW=19,img.width-=tempW):2==length&&(tempW=10,img.width-=tempW),caller.addChild(img),side){case 0:0==corner?(img.x=tempW,img.y=-img.height):(img.x=caller.width-img.width-tempW,img.y=-img.height);break;case 1:img.rotation=90,0==corner?(img.x=caller.width+img.height,img.y=tempW):(img.x=caller.width+img.height,img.y=caller.width-img.width-tempW);break;case 2:img.rotation=180,0==corner?(img.x=caller.width-tempW,img.y=caller.height+img.height):(img.x=img.width+tempW,img.y=caller.height+img.height);break;case 3:img.rotation=270,0==corner?(img.x=-img.height,img.y=caller.height-tempW):(img.x=-img.height,img.y=img.width+tempW)}}static addOutAngle(caller,corner){let img=new Laya.Image(ResConfig.getBoardURL("outAngle.png"));switch(caller.addChild(img),corner){case 0:img.y=-img.height/2,img.x=-(img.width/2-1);break;case 1:img.rotation=90,img.x=caller.width+img.height/2,img.y=-(img.width/2-1);break;case 2:img.rotation=180,img.y=caller.height+img.height/2,img.x=caller.width+img.width/2-1;break;case 3:img.rotation=270,img.y=caller.width+img.width/2-1,img.x=-img.height/2}}static addInAngle(caller,side,corner){let img=new Laya.Image(ResConfig.getBoardURL("inAngle.png"));switch(caller.addChild(img),side){case 0:0==corner?img.y=-img.height:(img.skewY=180,img.x=caller.width,img.y=-img.height);break;case 1:img.rotation=90,0==corner?img.x=caller.width+img.height:(img.skewY=180,img.x=caller.width+img.height,img.y=caller.height);break;case 2:img.rotation=180,0==corner?(img.x=caller.width,img.y=caller.height+img.height):(img.skewY=180,img.y=caller.height+img.height);break;case 3:img.rotation=270,0==corner?(img.x=-img.height,img.y=caller.height):(img.skewY=180,img.x=-img.height)}}}class EnumCmdName{}EnumCmdName.PLAYER_DATA="/mini/user",EnumCmdName.POSTER="/mini/poster",EnumCmdName.START="/game/start",EnumCmdName.END="/game/end",EnumCmdName.MOVE="/game/move2",EnumCmdName.HELP="/game/help",EnumCmdName.ASSIST="/game/assist";class RequestItem{}const key=CryptoJS.enc.Utf8.parse("e6A#9b4*%47e5Db6"),iv=CryptoJS.enc.Utf8.parse("12df*(jxwG&JgFD#");class HttpClient extends Laya.EventDispatcher{constructor(){super(),this._isProcessing=!1,this._requestQueue=[]}static get instance(){return HttpClient._instance||(HttpClient._instance=new HttpClient)}request(cmd,params,isCrypto=!1,successHandler=null,errorHandler=null,timeoutHandler=null,isMove=!1){if(Global.isOffline)return;let item=new RequestItem;item.cmd=cmd,item.params=params,item.isCrypto=isCrypto,item.successHandler=successHandler,item.errorHandler=errorHandler,item.timeoutHandler=timeoutHandler,item.isMove=isMove,this._requestQueue.push(item),this._isProcessing||(this._isProcessing=!0,this.next())}next(){if(0==this._requestQueue.length)return void(this._isProcessing=!1);let item=this._requestQueue[0];this._requestQueue.splice(0,1),this.doRequest(item.cmd,item.params,item.isCrypto,item.successHandler,item.errorHandler,item.timeoutHandler,item.isMove)}doRequest(cmd,params,isCrypto=!1,successHandler=null,errorHandler=null,timeoutHandler=null,isMove=!1){let packet;params=params||{},Log.log(`请求类型${cmd}`,params),isMove?packet=params:(packet=JSON.stringify(params),isCrypto&&(packet=function(word){let srcs=CryptoJS.enc.Utf8.parse(word);return CryptoJS.AES.encrypt(srcs,key,{iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString().toUpperCase()}(packet)));let url=Global.plat_api+cmd,xhr=new Laya.HttpRequest;xhr.http.timeout=3e3,xhr&&(xhr.once(Laya.Event.COMPLETE,this,d=>{successHandler&&successHandler.runWith(d),this.next()}),xhr.once(Laya.Event.ERROR,this,d=>{if(errorHandler&&errorHandler.runWith(d),"string"==typeof d){let status=xhr.http.status;if(302==status||304==status){let nowSearchStr=window.location.search;window.location.href=xhr.http.responseText+nowSearchStr}else 429==status?alert("请求频繁，请稍后再试！"):419==status?alert("请求参数错误"):500==status&&alert("请求后端程序报错");d.length>30&&(d=d.substr(1,30)),Log.log("错误信息",d)}else Log.log("网络异常");this.next()}),xhr.http.ontimeout=(e=>{timeoutHandler&&timeoutHandler.runWith(e),this.next()}),isMove?xhr.send(url+`?t=${(new Date).getTime()}`,packet,"post","text",["Content-Type","text/plain"]):isCrypto?xhr.send(url+`?t=${(new Date).getTime()}`,packet,"post","json",["Accept","application/json","Content-Type","text/plain"]):xhr.send(url+`?t=${(new Date).getTime()}`,packet,"post","json",["Accept","application/json","Content-Type","application/json"]))}}class StorageConfig{}StorageConfig.PLAYER_INFO="PLAYER_INFO",StorageConfig.PLAYER_LEVEL="PLAYER_LEVEL";class PlayerManager{constructor(){this._user=null,this._localUserInfo=null,this.getUserInfoSuc=!1,this._user=new Player,this.loadLocalInfo()}static get ins(){return null==PlayerManager.instance&&(PlayerManager.instance=new PlayerManager),PlayerManager.instance}get user(){return this._user}init(code){code&&(this._user.code=code)}getPlayerData(func){if(Global.isOffline){this.getUserInfoSuc=!0,Log.log("离线模式"),null==this._localUserInfo&&(this._localUserInfo={level:1,hp:5,rule_alert:0,star:0,time:Utils.getDay()},this.saveLocalInfo());for(let key in this._localUserInfo)this._user[key]=this._localUserInfo[key];func()}else HttpClient.instance.request(EnumCmdName.PLAYER_DATA,{},!0,Laya.Handler.create(this,this.getPlayerDataOk,[func]),Laya.Handler.create(this,this.getPlayerDataError,[func]),Laya.Handler.create(this,this.getPlayerDataTimeout))}getPlayerDataOk(func,data){data&&0==data.ret?(this._user.token=data.data.token,this._user.hp=data.data.life,this._user.level=data.data.level,this._user.star=data.data.star,this._user.nickname=data.data.nickname,this._user.account=data.data.account,this._user.cards=data.data.cards,this._user.prize_list_status=data.data.prize_list_status,this._user.game_prize_status=data.data.game_prize_status,this._user.card_prize_status=data.data.card_prize_status,this._user.life_status=data.data.life_status,this.getUserInfoSuc=!0,Log.log("玩家信息",this._user)):(this.getUserInfoSuc=!1,Log.log("获取玩家数据出错")),func()}getPlayerDataError(){}getPlayerDataTimeout(){Laya.Browser.window.alert("获取用户数据超时，请返回首页重新进入")}updateResult(data){let level=data.level,hp=data.life;this._user.level!=level&&(this._user.level=level),this._user!=hp&&(this._user.hp=hp),this.saveLocalInfo()}loadLocalInfo(){if(!Global.isOffline)return;let playerInfo=localStorage.getItem(StorageConfig.PLAYER_INFO);if(null!=playerInfo&&""!=playerInfo.trim())try{let strJson=JSON.parse(playerInfo);this._localUserInfo=strJson.user,this.checkTime()}catch(err){Log.log(err)}}saveLocalInfo(){if(!Global.isOffline)return;let strJson={user:this._localUserInfo};localStorage.setItem(StorageConfig.PLAYER_INFO,JSON.stringify(strJson))}updateLocalResult(result){if(!Global.isOffline)return;let needSave=!1;if(!result.win)return this._localUserInfo.hp=this._user.hp,void this.saveLocalInfo();let level=result.level,star=result.star;level==this._localUserInfo.level&&level<=Global.maxLevel&&(this._localUserInfo.level=level+1,this._user.level=level+1,this._localUserInfo.star+=star,this._user.star+=star,needSave=!0),needSave&&this.saveLocalInfo()}checkTime(){if(!Global.isOffline)return;let time=Utils.getDay();time>this._localUserInfo.time&&(this._localUserInfo.hp=Global.maxHp,this._user.hp=Global.maxHp,this._localUserInfo.time=time,this.saveLocalInfo())}}class PrepareUrl extends PrepareItem{constructor(){super()}onInit(){super.onInit(),this._counter=0}start(){this.progressHandler.runWith("加载URL上的信息");var res=UrlManager.instance.getUrlParams();PlayerManager.ins.init(res.code),PlayerManager.ins.getPlayerData(this.getUserDataOK.bind(this))}getUserDataOK(){this.complete()}dispose(){super.dispose()}get progress(){return 10}}var EffectList,PropsEffectList,BackType,Direction,ClearType,Target;!function(EffectList){EffectList[EffectList.chuanghu1=0]="chuanghu1",EffectList[EffectList.chuanghu2=1]="chuanghu2",EffectList[EffectList.jiutan1=2]="jiutan1",EffectList[EffectList.jiutan2=3]="jiutan2",EffectList[EffectList.xiangzi1=4]="xiangzi1",EffectList[EffectList.xiangzi2=5]="xiangzi2",EffectList[EffectList.kuaizi1=6]="kuaizi1",EffectList[EffectList.kuaizi2=7]="kuaizi2",EffectList[EffectList.putong=8]="putong"}(EffectList||(EffectList={})),function(PropsEffectList){PropsEffectList[PropsEffectList.rocket_idle=0]="rocket_idle",PropsEffectList[PropsEffectList.rocket_play=1]="rocket_play",PropsEffectList[PropsEffectList.bomb_idle=2]="bomb_idle",PropsEffectList[PropsEffectList.bomb_play1=3]="bomb_play1",PropsEffectList[PropsEffectList.bomb_play2=4]="bomb_play2",PropsEffectList[PropsEffectList.ball_idle=5]="ball_idle",PropsEffectList[PropsEffectList.ball_play1=6]="ball_play1",PropsEffectList[PropsEffectList.ball_play2=7]="ball_play2",PropsEffectList[PropsEffectList.plane_idle=8]="plane_idle",PropsEffectList[PropsEffectList.plane_play1=9]="plane_play1",PropsEffectList[PropsEffectList.plane_play2=10]="plane_play2",PropsEffectList[PropsEffectList.bomb1=11]="bomb1",PropsEffectList[PropsEffectList.bomb2=12]="bomb2",PropsEffectList[PropsEffectList.bomb3=13]="bomb3",PropsEffectList[PropsEffectList.bomb4=14]="bomb4",PropsEffectList[PropsEffectList.bomb5=15]="bomb5",PropsEffectList[PropsEffectList.rukou=16]="rukou",PropsEffectList[PropsEffectList.chukou=17]="chukou",PropsEffectList[PropsEffectList.wuxianjiantou=18]="wuxianjiantou"}(PropsEffectList||(PropsEffectList={}));class DonutData{constructor(maxNum=3,waitingTime=10,colArr=[]){this.maxNum=maxNum,this.waitingTime=waitingTime,this.colArr=colArr,this.count=waitingTime}}class LevelTarget{constructor(){this.targetDataArr=[]}addTarget(type,num){let targetData={};targetData.type=type,targetData.num=num,this.targetDataArr.push(targetData)}updateTargetNum(arr){for(let i=0;i<arr.length;i++)for(let k=0;k<this.targetDataArr.length;k++)if(this.targetDataArr[k].type==arr[i]&&0!=this.targetDataArr[k].num){this.targetDataArr[k].num--;break}}isTargetItem(target){for(let i=0;i<this.targetDataArr.length;i++)if(this.targetDataArr[i].type==target)return 0!=this.targetDataArr[i].num;return!1}isClear(){let len=this.targetDataArr.length;for(let i=0;i<len;i++)if(this.targetDataArr[i].num>0)return!1;return!0}}class RoomData{constructor(){this.roomTarget=new LevelTarget,this.itemArr=[],this.backArr=[],this.otherArr=[]}}!function(BackType){BackType[BackType.DEAD=0]="DEAD",BackType[BackType.NORMAL=1]="NORMAL",BackType[BackType.GRASS=2]="GRASS"}(BackType||(BackType={}));class EventHandler{static AddListener(eventName,caller,handle){this.eventDispatcher.on(eventName,caller,handle)}static RemoveListener(eventName,caller,handle){this.eventDispatcher.off(eventName,caller,handle)}static Dispatch(eventName,args){this.eventDispatcher.event(eventName,args)}}EventHandler.eventDispatcher=new Laya.EventDispatcher;class EventName{}EventName.CHANGE_ORDER="CHANGE_ORDER",EventName.ADD_ITEM="ADD_ITEM",EventName.UPDATE_STEP="UPDATE_STEP",EventName.UPDATE_TARGET_NUM="UPDATE_TARGET_NUM",EventName.LEVEL_FAILED="LEVEL_FAILED",EventName.LEVEL_CLEAR="LEVEL_CLEAR",EventName.NEXT_ROOM="NEXT_ROOM",EventName.E_Visibility_Background="E_Visibility_Background",EventName.E_Visibility_Foreground="E_Visibility_Foreground",EventName.RECONNECT="RECONNECT";class AniManager{static playClearAni(caller,callback){if(0==EffectManager.Instance.templetsLoads[EffectList.putong])return void callback.run();let skeleton0;(skeleton0=EffectManager.Instance.templets[EffectList.putong].buildArmature(0)).pos(GameData.ins.IconW/2,GameData.ins.IconH/2),skeleton0.play(0,!1),skeleton0.playbackRate(.8),skeleton0.scale(Global.scale,Global.scale),caller.addChild(skeleton0),Laya.timer.once(Global.CLEARTWEENTIME,this,()=>{callback.run(),skeleton0.removeSelf(),skeleton0.destroy()})}static playMoveToTargetAni(x,y,skin,callback){"icon/cherry1.png"==skin&&(skin="icon/cherry0.png");let img=new Laya.Image(skin);img.width=GameData.ins.IconW,img.height=GameData.ins.IconH,img.x=x+GameData.ins.offsetX+15+720*(1-Global.scale)/2,img.y=y+Global.boardHeight,Laya.stage.addChild(img),Laya.Tween.to(img,{x:420,y:230,scaleX:.1,scaleY:.1},2*Global.TWEENTIME,null,Laya.Handler.create(this,()=>{img.removeSelf(),callback&&callback.run()}))}static playBeGrassAni(caller,callback){caller.scale(.1,.1),Laya.Tween.to(caller,{scaleX:1,scaleY:1},Global.TWEENTIME,null,callback)}static playFlyAni(id,targetId,skin,callback,name="play2"){if(0==EffectManager.Instance.propsTempletsLoads[skin])return void(callback&&callback.run());let skeleton0,idX=ChessBoard.ins.itemArr[id].posX*GameData.ins.IconW+GameData.ins.offsetX+15+720*(1-Global.scale)/2+GameData.ins.IconH/2,idY=ChessBoard.ins.itemArr[id].posY*GameData.ins.IconH+Global.boardHeight+GameData.ins.IconH/2,targetIdX=ChessBoard.ins.itemArr[targetId].posX*GameData.ins.IconW+GameData.ins.offsetX+15+720*(1-Global.scale)/2+GameData.ins.IconH/2,targetIdY=ChessBoard.ins.itemArr[targetId].posY*GameData.ins.IconH+Global.boardHeight+GameData.ins.IconH/2,distance=Math.floor(Math.sqrt(Math.pow(targetIdX-idX,2)+Math.pow(targetIdY-idY,2))),time=Math.floor(distance/600*1e3);(skeleton0=EffectManager.Instance.propsTemplets[skin].buildArmature(0)).pos(idX,idY),skeleton0.rotation=Utils.getRotationWithTwoPoint(idX,idY,targetIdX,targetIdY),skin==PropsEffectList.plane_play2&&(skeleton0.rotation+=90),skin==PropsEffectList.bomb5&&(skeleton0.rotation+=90),Laya.Tween.to(skeleton0,{x:targetIdX,y:targetIdY},time,null,Laya.Handler.create(this,()=>{skeleton0.removeSelf(),skeleton0.destroy(),callback&&callback.run()})),skeleton0.scale(Global.scale,Global.scale),skin==PropsEffectList.bomb5?skeleton0.play(0,!0):skeleton0.play(name,!0),Laya.stage.addChild(skeleton0)}static moveToIdPosAni(caller,x,y,tweenTime,callback){Laya.Tween.to(caller,{x:x,y:y},tweenTime,null,callback)}static playEffect(skin,id,name="play"){let idX=ChessBoard.ins.itemArr[id].x+GameData.ins.offsetX+15+720*(1-Global.scale)/2+GameData.ins.IconH/2,idY=ChessBoard.ins.itemArr[id].y+Global.boardHeight+GameData.ins.IconW/2;EffectManager.Instance.playEffect(skin,name,idX,idY)}static playPropEffect(skin,id,rotation=0,callback=null){let idX=ChessBoard.ins.itemArr[id].x+GameData.ins.offsetX+15+720*(1-Global.scale)/2+GameData.ins.IconH/2,idY=ChessBoard.ins.itemArr[id].y+Global.boardHeight+GameData.ins.IconW/2;EffectManager.Instance.playPropEffect(skin,idX,idY,rotation,callback)}static playBombAni(caller,skin,name="play"){if(0==EffectManager.Instance.propsTempletsLoads[skin])return;let skeleton0;(skeleton0=EffectManager.Instance.propsTemplets[skin].buildArmature(0)).pos(GameData.ins.IconW/2,GameData.ins.IconH/2-10*Global.scale),skeleton0.scale(Global.scale,Global.scale),skeleton0.play(name,!1),caller.addChild(skeleton0),skeleton0.on(Laya.Event.STOPPED,this,()=>{skeleton0.removeSelf(),skeleton0.destroy()})}}!function(Direction){Direction[Direction.UP=0]="UP",Direction[Direction.DOWN=1]="DOWN",Direction[Direction.LEFT=2]="LEFT",Direction[Direction.RIGHT=3]="RIGHT"}(Direction||(Direction={}));class SoundManager extends Laya.EventDispatcher{constructor(){super(),this._soundState=0,this._musicState=0,this._isStop=!1,this.soundList=[],this.soundObj={}}static get instance(){return this._instance||(this._instance=new SoundManager)}get sound_state(){return this._soundState}set sound_state(val){this._soundState=val}get music_state(){return this._musicState}set music_state(val){this._musicState=val}init(){if(!PlayFromUtil.isWXPlatform())return;this.initSound();let wx=Laya.Browser.window.wx;wx.onShow(function(res){SoundManager.instance.updatepdateSound()}),wx.onHide(function(){SoundManager.instance.stopAll()})}initSound(){if(this.playMusic("bgm"),PlayFromUtil.isWXPlatform()){let wx=Laya.Browser.window.wx;wx.onAudioInterruptionEnd(function(){this.playMusic("bgm")}),wx.onAudioInterruptionBegin(function(){Laya.SoundManager.stopMusic()})}}updatepdateSound(d=null){if(this.isPlay())if(1==this.sound_state&&Laya.SoundManager.stopAllSound(),1==this.music_state)Laya.SoundManager.stopMusic();else{let name="Scenes.current.name";-1==name.search("Relive")&&-1==name.search("Result")&&this.playMusic("bgm")}}isPlay(){return 1!=this.music_state}stopAll(){Laya.SoundManager.stopAll()}playMusic(name){1!=this.music_state&&(Laya.SoundManager.musicVolume=.3,this.bgmChannel=Laya.SoundManager.playMusic(ResConfig.getSoundURL(name+".mp3"),0))}pauseMusic(){this.bgmChannel&&this.bgmChannel.pause()}resumeMusic(){this.bgmChannel&&this.bgmChannel.resume()}playSound(name,loop=1){1!=this.sound_state&&(null!=this.soundObj[name]&&1==this.soundObj[name]||(this.soundObj[name]=!0,Laya.timer.once(100,this,()=>{this.soundObj[name]=!1}),Laya.SoundManager.playSound(ResConfig.getSoundURL(name+".mp3"),loop)))}stopSound(name){Laya.SoundManager.stopSound(ResConfig.getSoundURL(name+".mp3"))}addItemSound(type,hp){let name="";switch(type){case ItemType.BOX:name="box"+hp;break;case ItemType.CHERRY:name="suger"+hp;break;case ItemType.SUGER:name="suger"+(hp-1);break;case ItemType.LOCKED:name="locked1";break;case ItemType.BISCUIT:name="biscuit"+hp}""!=name&&this.soundList.indexOf(name)<0&&this.soundList.push(name)}playItemSound(){for(let i=0;i<this.soundList.length;i++)this.playSound(this.soundList[i]);this.soundList=[]}}class Props{static useProps(id,exchangeId,type,withOutArr=[],wait=!1){let prop=type||ChessBoard.ins.itemArr[id].type,arr=[],waitTime=0;switch(wait&&(waitTime=Global.USEPROPSTIME),prop){case ItemType.HENG:arr=[id],ChessBoard.ins.addItem(id,Direction.LEFT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.RIGHT,GameData.ins.col,arr,!0,!0),Laya.timer.once(waitTime,this,()=>{SoundManager.instance.playSound("rocket"),AniManager.playPropEffect(PropsEffectList.rocket_play,id,90),AniManager.playPropEffect(PropsEffectList.rocket_play,id,270)}),Log.log("横向火箭",arr);break;case ItemType.SHU:arr=[id],ChessBoard.ins.addItem(id,Direction.UP,GameData.ins.row,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.DOWN,GameData.ins.row,arr,!0,!0),Laya.timer.once(waitTime,this,()=>{SoundManager.instance.playSound("rocket"),AniManager.playPropEffect(PropsEffectList.rocket_play,id,180),AniManager.playPropEffect(PropsEffectList.rocket_play,id,0)}),Log.log("纵向火箭",arr);break;case ItemType.BOMB:let BOMB_tempArr=[id];ChessBoard.ins.addItem(id,Direction.UP,1,BOMB_tempArr),ChessBoard.ins.addItem(id,Direction.DOWN,1,BOMB_tempArr);for(let i=0;i<BOMB_tempArr.length;i++)arr.push(BOMB_tempArr[i]),ChessBoard.ins.addItem(BOMB_tempArr[i],Direction.LEFT,2,arr),ChessBoard.ins.addItem(BOMB_tempArr[i],Direction.RIGHT,2,arr);BOMB_tempArr=[],id-2*GameData.ins.col>0&&BOMB_tempArr.push(id-2*GameData.ins.col),id+2*GameData.ins.col<GameData.ins.col*GameData.ins.row&&BOMB_tempArr.push(id+2*GameData.ins.col);for(let i=0;i<BOMB_tempArr.length;i++)arr.push(BOMB_tempArr[i]),ChessBoard.ins.addItem(BOMB_tempArr[i],Direction.LEFT,1,arr),ChessBoard.ins.addItem(BOMB_tempArr[i],Direction.RIGHT,1,arr);Laya.timer.once(waitTime,this,()=>{SoundManager.instance.playSound("bomb"),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.bomb_play1,id)}),Log.log("炸弹：",arr);break;case ItemType.BALL:let BALL_color;ChessBoard.ins.isPause=!0,ChessBoard.ins.waitClearNum++,BALL_color=exchangeId?ChessBoard.ins.itemArr[exchangeId].color:ChessBoard.ins.getRandomColor();let BALL_arr=ChessBoard.ins.findSameColor(BALL_color);Laya.timer.once(waitTime,this,()=>{if(SoundManager.instance.playSound("ball",0),AniManager.playPropEffect(PropsEffectList.ball_play1,id),BALL_arr.length>0){let BALL_count=0;for(let i=0;i<BALL_arr.length;i++)Laya.timer.once(100*i,this,()=>{AniManager.playFlyAni(id,BALL_arr[i],PropsEffectList.bomb5,Laya.Handler.create(this,()=>{BALL_count++,ChessBoard.ins.itemArr[BALL_arr[i]].playBallSelectAni(PropsEffectList.bomb4),ChessBoard.ins.emptyArr.push(BALL_arr[i]),ChessBoard.ins.usePropsClearArr.push(BALL_arr[i]),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr([BALL_arr[i]]),BALL_count==BALL_arr.length&&(SoundManager.instance.stopSound("ball"),Laya.timer.once(300,this,()=>{for(let k=0;k<BALL_arr.length;k++)AniManager.playPropEffect(PropsEffectList.bomb1,BALL_arr[k]),ChessBoard.ins.itemArr[BALL_arr[i]].stopPlayBallSelectAni();AniManager.playPropEffect(PropsEffectList.ball_play2,id),ChessBoard.ins.emptyArr.push(id),ChessBoard.ins.startClear()}))}))})}else AniManager.playPropEffect(PropsEffectList.ball_play2,id),ChessBoard.ins.emptyArr.push(id),ChessBoard.ins.startClear()}),Log.log("彩虹球：",arr);break;case ItemType.PLANE:ChessBoard.ins.waitClearNum++,arr=[id],ChessBoard.ins.addItem(id,Direction.UP,1,arr),ChessBoard.ins.addItem(id,Direction.DOWN,1,arr),ChessBoard.ins.addItem(id,Direction.LEFT,1,arr),ChessBoard.ins.addItem(id,Direction.RIGHT,1,arr);let newWithOutArr=[];newWithOutArr.push(withOutArr),newWithOutArr.push.apply(newWithOutArr,arr),Laya.timer.once(waitTime,this,()=>{SoundManager.instance.playSound("plane"),ChessBoard.ins.backArr[id].playBombAni(),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.plane_play1,id,0,Laya.Handler.create(this,()=>{let planeId=ChessBoard.ins.findOneOfTargetItem(id,newWithOutArr);ChessBoard.ins.waitWithOutArr.push(planeId),AniManager.playPropEffect(PropsEffectList.bomb2,planeId),AniManager.playFlyAni(id,planeId,PropsEffectList.plane_play2,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb1,planeId),ChessBoard.ins.emptyArr.push(planeId),ChessBoard.ins.usePropsClearArr.push(planeId),ChessBoard.ins.checkComboProps([planeId]),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr([planeId]),ChessBoard.ins.startClear(),ChessBoard.ins.waitWithOutArr.splice(ChessBoard.ins.waitWithOutArr.indexOf(planeId),1),Log.log("纸飞机飞向的格子ID为：",planeId)}))}))}),Log.log("飞机：",arr);break;case ItemType.ROCKET_ROCKET:arr=[id],ChessBoard.ins.addItem(id,Direction.LEFT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.RIGHT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.UP,GameData.ins.row,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.DOWN,GameData.ins.row,arr,!0,!0),SoundManager.instance.playSound("rocket"),AniManager.playPropEffect(PropsEffectList.rocket_play,id,180),AniManager.playPropEffect(PropsEffectList.rocket_play,id,0),AniManager.playPropEffect(PropsEffectList.rocket_play,id,270),AniManager.playPropEffect(PropsEffectList.rocket_play,id,90),Log.log("十字火箭",arr);break;case ItemType.ROCKET_BOMB:arr=[id];let posX=id%GameData.ins.col,posY=Math.floor(id/GameData.ins.col);ChessBoard.ins.addItem(id,Direction.LEFT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.RIGHT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.UP,GameData.ins.row,arr,!0,!0),ChessBoard.ins.addItem(id,Direction.DOWN,GameData.ins.row,arr,!0,!0),posY>0&&(ChessBoard.ins.addItem(id-GameData.ins.col,Direction.LEFT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id-GameData.ins.col,Direction.RIGHT,GameData.ins.col,arr,!0,!0)),posY<GameData.ins.row-1&&(ChessBoard.ins.addItem(id+GameData.ins.col,Direction.LEFT,GameData.ins.col,arr,!0,!0),ChessBoard.ins.addItem(id+GameData.ins.col,Direction.RIGHT,GameData.ins.col,arr,!0,!0)),posX>0&&(ChessBoard.ins.addItem(id-1,Direction.UP,GameData.ins.row,arr,!0,!0),ChessBoard.ins.addItem(id-1,Direction.DOWN,GameData.ins.row,arr,!0,!0)),posX<GameData.ins.col-1&&(ChessBoard.ins.addItem(id+1,Direction.UP,GameData.ins.row,arr,!0,!0),ChessBoard.ins.addItem(id+1,Direction.DOWN,GameData.ins.row,arr,!0,!0)),SoundManager.instance.playSound("rocket"),posY>0&&(AniManager.playPropEffect(PropsEffectList.rocket_play,id-GameData.ins.col,90),AniManager.playPropEffect(PropsEffectList.rocket_play,id-GameData.ins.col,270)),posY<GameData.ins.row-1&&(AniManager.playPropEffect(PropsEffectList.rocket_play,id+GameData.ins.col,90),AniManager.playPropEffect(PropsEffectList.rocket_play,id+GameData.ins.col,270)),posX>0&&(AniManager.playPropEffect(PropsEffectList.rocket_play,id-1,180),AniManager.playPropEffect(PropsEffectList.rocket_play,id-1,0)),posX<GameData.ins.col-1&&(AniManager.playPropEffect(PropsEffectList.rocket_play,id+1,180),AniManager.playPropEffect(PropsEffectList.rocket_play,id+1,0)),AniManager.playPropEffect(PropsEffectList.rocket_play,id,90),AniManager.playPropEffect(PropsEffectList.rocket_play,id,270),AniManager.playPropEffect(PropsEffectList.rocket_play,id,180),AniManager.playPropEffect(PropsEffectList.rocket_play,id,0),Log.log("火箭炸弹",arr);break;case ItemType.ROCKET_BALL:ChessBoard.ins.waitClearNum++;let ROCKET_BALL_isHeng,ROCKET_BALL_color=ChessBoard.ins.getRandomColor();Log.log("颜色：",ROCKET_BALL_color+"变成火箭");let R_BALL_tempArr=[],ROCKET_BALL_arr=ChessBoard.ins.findSameColor(ROCKET_BALL_color);SoundManager.instance.playSound("ball",0),AniManager.playPropEffect(PropsEffectList.ball_play1,id);let ROCKET_BALL_count=0;for(let i=0;i<ROCKET_BALL_arr.length;i++)Laya.timer.once(100*i,this,()=>{AniManager.playFlyAni(id,ROCKET_BALL_arr[i],PropsEffectList.bomb5,Laya.Handler.create(this,()=>{if(ROCKET_BALL_count++,ChessBoard.ins.itemArr[ROCKET_BALL_arr[i]].hp>1||ChessBoard.ins.itemArr[ROCKET_BALL_arr[i]].type==ItemType.DONUT?ChessBoard.ins.itemArr[ROCKET_BALL_arr[i]].clearSelf():1==(ROCKET_BALL_isHeng=Math.ceil(2*Math.random()))?ChessBoard.ins.itemArr[ROCKET_BALL_arr[i]].changeType(ItemType.HENG):ChessBoard.ins.itemArr[ROCKET_BALL_arr[i]].changeType(ItemType.SHU),ROCKET_BALL_count==ROCKET_BALL_arr.length){SoundManager.instance.stopSound("ball"),AniManager.playPropEffect(PropsEffectList.ball_play2,id);for(let k=0;k<ROCKET_BALL_arr.length;k++)R_BALL_tempArr.push.apply(R_BALL_tempArr,ChessBoard.ins.itemArr[ROCKET_BALL_arr[k]].useProps(null,null,!0));Laya.timer.once(Global.USEPROPSTIME,this,()=>{R_BALL_tempArr=Utils.unique(R_BALL_tempArr),ChessBoard.ins.emptyArr.push(...R_BALL_tempArr),ChessBoard.ins.usePropsClearArr.push(...R_BALL_tempArr),ChessBoard.ins.checkComboProps(R_BALL_tempArr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(R_BALL_tempArr),ChessBoard.ins.emptyArr.push(id,exchangeId),ChessBoard.ins.startClear()})}}))});break;case ItemType.BOMB_BOMB:let BOMB_BOMB_tempArr=[exchangeId];ChessBoard.ins.addItem(exchangeId,Direction.UP,1,BOMB_BOMB_tempArr),ChessBoard.ins.addItem(exchangeId,Direction.DOWN,1,BOMB_BOMB_tempArr);for(let i=0;i<BOMB_BOMB_tempArr.length;i++)arr.push(BOMB_BOMB_tempArr[i]),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.LEFT,3,arr),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.RIGHT,3,arr);BOMB_BOMB_tempArr=[],exchangeId-2*GameData.ins.col>0&&BOMB_BOMB_tempArr.push(exchangeId-2*GameData.ins.col),exchangeId+2*GameData.ins.col<GameData.ins.col*GameData.ins.row&&BOMB_BOMB_tempArr.push(exchangeId+2*GameData.ins.col);for(let i=0;i<BOMB_BOMB_tempArr.length;i++)arr.push(BOMB_BOMB_tempArr[i]),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.LEFT,2,arr),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.RIGHT,2,arr);BOMB_BOMB_tempArr=[],exchangeId-3*GameData.ins.col>0&&BOMB_BOMB_tempArr.push(exchangeId-3*GameData.ins.col),exchangeId+3*GameData.ins.col<GameData.ins.col*GameData.ins.row&&BOMB_BOMB_tempArr.push(exchangeId+3*GameData.ins.col);for(let i=0;i<BOMB_BOMB_tempArr.length;i++)arr.push(BOMB_BOMB_tempArr[i]),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.LEFT,1,arr),ChessBoard.ins.addItem(BOMB_BOMB_tempArr[i],Direction.RIGHT,1,arr);SoundManager.instance.playSound("bomb"),AniManager.playPropEffect(PropsEffectList.bomb_play2,id),Log.log("超级炸弹：",arr);break;case ItemType.BOMB_BALL:ChessBoard.ins.waitClearNum++;let BOMB_BALL_color=ChessBoard.ins.getRandomColor(),B_BALL_tempArr=[];Log.log("颜色：",BOMB_BALL_color+"变成炸弹");let BOMB_BALL_arr=ChessBoard.ins.findSameColor(BOMB_BALL_color);SoundManager.instance.playSound("ball",0),AniManager.playPropEffect(PropsEffectList.ball_play1,id);let BOMB_BALL_count=0;for(let i=0;i<BOMB_BALL_arr.length;i++)Laya.timer.once(100*i,this,()=>{AniManager.playFlyAni(id,BOMB_BALL_arr[i],PropsEffectList.bomb5,Laya.Handler.create(this,()=>{if(BOMB_BALL_count++,ChessBoard.ins.itemArr[BOMB_BALL_arr[i]].hp>1||ChessBoard.ins.itemArr[BOMB_BALL_arr[i]].type==ItemType.DONUT?ChessBoard.ins.itemArr[BOMB_BALL_arr[i]].clearSelf():ChessBoard.ins.itemArr[BOMB_BALL_arr[i]].changeType(ItemType.BOMB),BOMB_BALL_count==BOMB_BALL_arr.length){SoundManager.instance.stopSound("ball"),AniManager.playPropEffect(PropsEffectList.ball_play2,id);for(let k=0;k<BOMB_BALL_arr.length;k++)B_BALL_tempArr.push.apply(B_BALL_tempArr,ChessBoard.ins.itemArr[BOMB_BALL_arr[k]].useProps(null,null,!0));Laya.timer.once(Global.USEPROPSTIME,this,()=>{B_BALL_tempArr=Utils.unique(B_BALL_tempArr),ChessBoard.ins.emptyArr.push(...B_BALL_tempArr),ChessBoard.ins.usePropsClearArr.push(...B_BALL_tempArr),ChessBoard.ins.checkComboProps(B_BALL_tempArr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(B_BALL_tempArr),ChessBoard.ins.emptyArr.push(id,exchangeId),ChessBoard.ins.startClear()})}}))});break;case ItemType.BALL_BALL:for(let i=0;i<ChessBoard.ins.itemArr.length;i++)arr.push(i);SoundManager.instance.playSound("ball"),AniManager.playPropEffect(PropsEffectList.ball_play1,id),AniManager.playPropEffect(PropsEffectList.ball_play2,id);break;case ItemType.PLANE_H_ROCKET:ChessBoard.ins.waitClearNum++,arr=[id],ChessBoard.ins.addItem(id,Direction.UP,1,arr),ChessBoard.ins.addItem(id,Direction.DOWN,1,arr),ChessBoard.ins.addItem(id,Direction.LEFT,1,arr),ChessBoard.ins.addItem(id,Direction.RIGHT,1,arr);let PLANE_H_ROCKET_Arr=[],H_R_planeId=ChessBoard.ins.findOneOfTargetItem(id,arr);SoundManager.instance.playSound("plane"),ChessBoard.ins.backArr[id].playBombAni(),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.plane_play1,id,0,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb2,H_R_planeId),AniManager.playFlyAni(id,H_R_planeId,PropsEffectList.plane_play2,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb1,H_R_planeId),PLANE_H_ROCKET_Arr.push.apply(PLANE_H_ROCKET_Arr,Props.useProps(H_R_planeId,null,ItemType.HENG,null,!0)),Laya.timer.once(Global.USEPROPSTIME,this,()=>{PLANE_H_ROCKET_Arr=Utils.unique(PLANE_H_ROCKET_Arr),ChessBoard.ins.emptyArr.push(...PLANE_H_ROCKET_Arr),ChessBoard.ins.usePropsClearArr.push(...PLANE_H_ROCKET_Arr),ChessBoard.ins.checkComboProps(PLANE_H_ROCKET_Arr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(PLANE_H_ROCKET_Arr),ChessBoard.ins.startClear()})}))})),Log.log("纸飞机飞向的格子ID为：",H_R_planeId),Log.log("飞机横向火箭：",arr);break;case ItemType.PLANE_S_ROCKET:ChessBoard.ins.waitClearNum++,arr=[id],ChessBoard.ins.addItem(id,Direction.UP,1,arr),ChessBoard.ins.addItem(id,Direction.DOWN,1,arr),ChessBoard.ins.addItem(id,Direction.LEFT,1,arr),ChessBoard.ins.addItem(id,Direction.RIGHT,1,arr);let PLANE_S_ROCKET_Arr=[],S_R_planeId=ChessBoard.ins.findOneOfTargetItem(id,arr);SoundManager.instance.playSound("plane"),ChessBoard.ins.backArr[id].playBombAni(),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.plane_play1,id,0,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb2,S_R_planeId),AniManager.playFlyAni(id,S_R_planeId,PropsEffectList.plane_play2,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb1,S_R_planeId),PLANE_S_ROCKET_Arr.push.apply(PLANE_S_ROCKET_Arr,Props.useProps(S_R_planeId,null,ItemType.SHU,null,!0)),Laya.timer.once(Global.USEPROPSTIME,this,()=>{PLANE_S_ROCKET_Arr=Utils.unique(PLANE_S_ROCKET_Arr),ChessBoard.ins.emptyArr.push(...PLANE_S_ROCKET_Arr),ChessBoard.ins.usePropsClearArr.push(...PLANE_S_ROCKET_Arr),ChessBoard.ins.checkComboProps(PLANE_S_ROCKET_Arr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(PLANE_S_ROCKET_Arr),ChessBoard.ins.startClear()})}))})),Log.log("纸飞机飞向的格子ID为：",S_R_planeId),Log.log("飞机竖向火箭：",arr);break;case ItemType.PLANE_BOMB:ChessBoard.ins.waitClearNum++,arr=[id],ChessBoard.ins.addItem(id,Direction.UP,1,arr),ChessBoard.ins.addItem(id,Direction.DOWN,1,arr),ChessBoard.ins.addItem(id,Direction.LEFT,1,arr),ChessBoard.ins.addItem(id,Direction.RIGHT,1,arr);let PLANE_BOMB_Arr=[],BOMB_planeId=ChessBoard.ins.findOneOfTargetItem(id,arr);SoundManager.instance.playSound("plane"),ChessBoard.ins.backArr[id].playBombAni(),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.plane_play1,id,0,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb2,BOMB_planeId),AniManager.playFlyAni(id,BOMB_planeId,PropsEffectList.plane_play2,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb1,BOMB_planeId),PLANE_BOMB_Arr.push.apply(PLANE_BOMB_Arr,Props.useProps(BOMB_planeId,null,ItemType.BOMB,null,!0)),Laya.timer.once(Global.USEPROPSTIME,this,()=>{PLANE_BOMB_Arr=Utils.unique(PLANE_BOMB_Arr),ChessBoard.ins.emptyArr.push(...PLANE_BOMB_Arr),ChessBoard.ins.usePropsClearArr.push(...PLANE_BOMB_Arr),ChessBoard.ins.checkComboProps(PLANE_BOMB_Arr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(PLANE_BOMB_Arr),ChessBoard.ins.startClear()})}))})),Log.log("纸飞机飞向的格子ID为：",BOMB_planeId),Log.log("飞机炸弹",arr);break;case ItemType.PLANE_BALL:ChessBoard.ins.waitClearNum++;let P_BALL_color=ChessBoard.ins.getRandomColor(),P_BALL_tempArr=[];Log.log("颜色：",P_BALL_color+"变成飞机");let PLANE_BALL_arr=ChessBoard.ins.findSameColor(P_BALL_color);SoundManager.instance.playSound("ball",0),AniManager.playPropEffect(PropsEffectList.ball_play1,id,0);let PLANE_BALL_count=0;for(let i=0;i<PLANE_BALL_arr.length;i++)Laya.timer.once(100*i,this,()=>{AniManager.playFlyAni(id,PLANE_BALL_arr[i],PropsEffectList.bomb5,Laya.Handler.create(this,()=>{if(PLANE_BALL_count++,AniManager.playPropEffect(PropsEffectList.bomb1,PLANE_BALL_arr[i]),ChessBoard.ins.itemArr[PLANE_BALL_arr[i]].hp>1||ChessBoard.ins.itemArr[PLANE_BALL_arr[i]].type==ItemType.DONUT?ChessBoard.ins.itemArr[PLANE_BALL_arr[i]].clearSelf():ChessBoard.ins.itemArr[PLANE_BALL_arr[i]].changeType(ItemType.PLANE),PLANE_BALL_count==PLANE_BALL_arr.length){SoundManager.instance.stopSound("ball"),AniManager.playPropEffect(PropsEffectList.ball_play2,id);for(let k=0;k<PLANE_BALL_arr.length;k++)P_BALL_tempArr.push.apply(P_BALL_tempArr,ChessBoard.ins.itemArr[PLANE_BALL_arr[k]].useProps(null,P_BALL_tempArr,!0));Laya.timer.once(Global.USEPROPSTIME,this,()=>{P_BALL_tempArr=Utils.unique(P_BALL_tempArr),ChessBoard.ins.emptyArr.push(...P_BALL_tempArr),ChessBoard.ins.usePropsClearArr.push(...P_BALL_tempArr),ChessBoard.ins.checkComboProps(P_BALL_tempArr),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(P_BALL_tempArr),ChessBoard.ins.emptyArr.push(id,exchangeId),ChessBoard.ins.startClear()})}}))});break;case ItemType.PLANE_PLANE:ChessBoard.ins.waitClearNum+=3;let P_P_tempArr=[id];ChessBoard.ins.addItem(id,Direction.UP,1,P_P_tempArr),ChessBoard.ins.addItem(id,Direction.DOWN,1,P_P_tempArr);for(let i=0;i<P_P_tempArr.length;i++)arr.push(P_P_tempArr[i]),ChessBoard.ins.addItem(P_P_tempArr[i],Direction.LEFT,1,arr),ChessBoard.ins.addItem(P_P_tempArr[i],Direction.RIGHT,1,arr);SoundManager.instance.playSound("plane");let planeIdArr=[];ChessBoard.ins.backArr[id].playBombAni(),Laya.timer.once(100,this,()=>{for(let i=1;i<arr.length;i++)ChessBoard.ins.backArr[arr[i]].playBombAni()}),AniManager.playPropEffect(PropsEffectList.plane_play1,id,0,Laya.Handler.create(this,()=>{for(let i=0;i<3;i++)Laya.timer.once(200*i,this,()=>{let P_planeId=ChessBoard.ins.findOneOfTargetItem(id,arr);planeIdArr.push(P_planeId),ChessBoard.ins.waitWithOutArr.push(P_planeId),AniManager.playPropEffect(PropsEffectList.bomb2,P_planeId),AniManager.playFlyAni(id,P_planeId,PropsEffectList.plane_play2,Laya.Handler.create(this,()=>{AniManager.playPropEffect(PropsEffectList.bomb1,P_planeId),ChessBoard.ins.emptyArr.push(P_planeId),ChessBoard.ins.usePropsClearArr.push(P_planeId),ChessBoard.ins.checkComboProps([P_planeId]),ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr([P_planeId]),ChessBoard.ins.startClear(),ChessBoard.ins.waitWithOutArr.splice(ChessBoard.ins.waitWithOutArr.indexOf(planeIdArr[i]),1)})),Log.log("纸飞机飞向的格子ID为：",P_planeId)})})),Log.log("双飞机",arr)}return ChessBoard.ins.backArr[id].type==BackType.GRASS&&ChessBoard.ins.addToGrassArr(arr),arr}}Props.CompoundPropsObj={101101:ItemType.ROCKET_ROCKET,101102:ItemType.ROCKET_ROCKET,102102:ItemType.ROCKET_ROCKET,101103:ItemType.ROCKET_BOMB,102103:ItemType.ROCKET_BOMB,101104:ItemType.ROCKET_BALL,102104:ItemType.ROCKET_BALL,103103:ItemType.BOMB_BOMB,103104:ItemType.BOMB_BALL,104104:ItemType.BALL_BALL,101105:ItemType.PLANE_H_ROCKET,102105:ItemType.PLANE_S_ROCKET,103105:ItemType.PLANE_BOMB,104105:ItemType.PLANE_BALL,105105:ItemType.PLANE_PLANE},function(ClearType){ClearType[ClearType.UNABLE=0]="UNABLE",ClearType[ClearType.SELF=1]="SELF",ClearType[ClearType.NEXT=2]="NEXT",ClearType[ClearType.NEXT_NOT_PROPS=3]="NEXT_NOT_PROPS",ClearType[ClearType.ONLY_PROPS=4]="ONLY_PROPS"}(ClearType||(ClearType={})),function(Target){Target[Target.RED=1]="RED",Target[Target.YELLOW=2]="YELLOW",Target[Target.GREEN=3]="GREEN",Target[Target.PINK=4]="PINK",Target[Target.BLUE=5]="BLUE",Target[Target.DONUT=11]="DONUT",Target[Target.CHERRY=12]="CHERRY",Target[Target.GRASS=13]="GRASS",Target[Target.BISCUIT=14]="BISCUIT",Target[Target.BOX=15]="BOX",Target[Target.WALNUT=16]="WALNUT"}(Target||(Target={}));class GuideConfig{static getGuideByLevel(levelId,step=1){let data={mask:[]};switch(levelId){case 1:return 1==step?(data.txt="任意3个相同图案相连即可消除！。",data.tipsId=0,data.mask[0]={id:18,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:23,width:3*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[18,25],data.tips=[18,1],data):null;case 2:return 1==step?(data.txt="匹配4个图案来制作一个火箭。",data.tipsId=0,data.mask[0]={id:17,width:4*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:27,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[19,27],data.tips=[19,1],data):null;case 3:return 1==step?(data.txt="匹配5个元素来制作一个炸药。",data.tipsId=2,data.mask[0]={id:6,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:13,width:4*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[2]={id:24,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[15,16],data.tips=[15,3],data):null;case 4:return 1==step?(data.txt="匹配4个元素呈四方形来制作一个风筝。",data.tipsId=0,data.mask[0]={id:9,width:2*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:18,width:2*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[2]={id:27,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[18,27],data.tips=[18,1],data):2==step?(data.txt="除了交换，双击也可以使用道具哦！",data.tipsId=0,data.mask[0]={id:18,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[18],data):null;case 5:return 1==step?(data.txt="直线匹配5个元素来制作一个陀螺。",data.tipsId=0,data.mask[0]={id:31,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:38,width:5*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[31,40],data.tips=[31,1],data):2==step?(data.txt="将陀螺与相邻图案交换即可消除所有该图案。",data.tipsId=0,data.mask[0]={id:40,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:49,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.tips=[40,1],data):null;case 6:return 1==step?(data.txt="将道具组合起来，威力更大哦！",data.tipsId=0,data.mask[0]={id:68,width:2*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[68,69],data.tips=[68,3],data):null;case 7:return 1==step?(data.txt="从蓝木板区域向外匹配消除，就可以把蓝木板铺得更远！",data.tipsId=2,data.mask[0]={id:5,width:3*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:16,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[7,16],data.tips=[7,1],data):null;case 21:return 1==step?(data.txt="让玉佩掉下来即可通过此关卡。",data.tipsId=2,data.mask[0]={id:1,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:5,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[2]={id:24,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[],data):null;case 32:return 1==step?(data.txt="火箭穿过酒坛之后就会变得无效哦。",data.tipsId=2,data.mask[0]={id:10,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.mask[1]={id:19,width:1*GameData.ins.IconH,height:1*GameData.ins.IconH},data.allowArr=[10,19],data.tips=[10,1],data):null;default:return null}}}class Item extends Laya.Image{constructor(id,x,y,type,hp,color){super(),this.targetId=-1,this.movable=!0,this.exchangeable=!0,this.hp=1,this.color=-1,this.clearType=ClearType.SELF,this.penetrable=!0,this.isSelect=!1,this.isTipsItem=!1,this.skeleton=null,this.color=color,this.targetId=this.color,this.id=id,this.width=GameData.ins.IconW,this.height=GameData.ins.IconH,this.posX=x,this.posY=y,this.x=this.posX*this.width,this.y=this.posY*this.height,this.changeType(type,hp),this.on(Laya.Event.MOUSE_DOWN,this,this.onMouseDown),this.on(Laya.Event.MOUSE_UP,this,this.onMouseUp),this.on(Laya.Event.MOUSE_OVER,this,this.onMouseIn),this.on(Laya.Event.DOUBLE_CLICK,this,this.onDoubleClick)}changeColor(color){this.type==ItemType.NORMAL&&color!=this.color&&(this.color=color,this.targetId=this.color,this.updateType())}onMouseDown(e){if(ChessBoard.ins.isChanging||ChessBoard.ins.gameOver)return void Log.log("正在交换中，无法点击");if(0==this.exchangeable)return void Log.log("该Item无法交换,ID:",this.id);if(ChessBoard.ins.isGuideStep>0){let guideData=GuideConfig.getGuideByLevel(GameData.ins.levelId,ChessBoard.ins.isGuideStep);if(guideData&&guideData.allowArr&&guideData.allowArr.indexOf(this.id)<0)return}ChessBoard.ins.isMouseDown=!0,Log.log(`ID:${this.id},颜色：${this.color},HP:${this.hp}`);let sel=ChessBoard.ins.selectId;if(null==sel){if(null==this.color)return void Log.log("空格不允许当第一个选中的图案");this.setSelect(!0),ChessBoard.ins.selectId=this.id,ChessBoard.ins.lastSelectId=this.id}else sel==this.id?(this.setSelect(!1),ChessBoard.ins.selectId=null):ChessBoard.ins.checkExchangeItem(this.id)}onMouseUp(e){ChessBoard.ins.isMouseDown=!1}onMouseIn(e){if(ChessBoard.ins.isMouseDown&&0!=this.exchangeable){if(null==ChessBoard.ins.selectId){if(null==ChessBoard.ins.lastSelectId)return;ChessBoard.ins.selectId=ChessBoard.ins.lastSelectId}if(ChessBoard.ins.isGuideStep>0){let guideData=GuideConfig.getGuideByLevel(GameData.ins.levelId,ChessBoard.ins.isGuideStep);if(guideData&&guideData.allowArr&&guideData.allowArr.indexOf(this.id)<0)return}ChessBoard.ins.isMouseDown=!1,ChessBoard.ins.checkExchangeItem(this.id)}}onDoubleClick(e){if(ChessBoard.ins.isChanging||ChessBoard.ins.gameOver)return void Log.log("正在交换中，无法点击");if(this.type==ItemType.BALL)return void Log.log("彩虹球无法双击触发");let sel=ChessBoard.ins.selectId;(null==sel||sel==this.id)&&this.type>100&&ChessBoard.ins.checkExchangeItem(this.id,!0)}clearSelf(){this.clearType!=ClearType.UNABLE&&(2==this.hp&&this.type>100||(this.visible||this.targetId!=Target.DONUT)&&this.type!=ItemType.SPACE&&0!=this.hp&&(SoundManager.instance.addItemSound(this.type,this.hp),this.playAni(),this.hp--,0==this.hp?(GameData.ins.target.isTargetItem(this.targetId)&&(this.targetId==Target.DONUT&&ChessBoard.ins.donutNum--,AniManager.playMoveToTargetAni(this.x,this.y,this.skin,Laya.Handler.create(this,()=>{EventHandler.Dispatch(EventName.UPDATE_TARGET_NUM)})),ChessBoard.ins.addTargetItem(this.targetId)),this.skin=null,this.removeChildren(),AniManager.playClearAni(this,Laya.Handler.create(this,()=>{this.changeType(ItemType.SPACE),this.removeSelf()}))):1==this.hp&&this.color>0&&this.type<100?(ChessBoard.ins.addIdToLastMoveArr(this.id),this.changeType(ItemType.NORMAL,this.hp)):this.type<100&&this.updateType()))}changeType(type,hp){if(type!=this.type)switch(this.type=type,this.hp=hp,type){case ItemType.SPACE:this.changeToSpace();break;case ItemType.DEAD:this.clearType=ClearType.UNABLE,this.movable=!1,this.penetrable=!0,this.exchangeable=!1,this.color=-1,this.updateType();break;case ItemType.NORMAL:this.movable=!0,this.exchangeable=!0,this.hp=1,this.clearType=ClearType.SELF,this.penetrable=!0,this.updateType();break;case ItemType.LOCKED:this.movable=!1,this.exchangeable=!1,this.hp=hp,this.clearType=ClearType.SELF,this.penetrable=!0,this.updateType();break;case ItemType.SUGER:this.movable=!1,this.exchangeable=!1,this.hp=hp,this.clearType=ClearType.NEXT,this.penetrable=!0,this.updateType();break;case ItemType.ICE:this.movable=!0,this.exchangeable=!1,this.hp=hp,this.clearType=ClearType.SELF,this.penetrable=!0,this.updateType();break;case ItemType.BOX:this.targetId=Target.BOX,this.movable=!1,this.exchangeable=!1,this.hp=hp,this.clearType=ClearType.NEXT_NOT_PROPS,this.penetrable=!0,this.color=-1,this.updateType();break;case ItemType.DONUT:this.targetId=Target.DONUT,this.movable=!0,this.exchangeable=!0,this.clearType=ClearType.UNABLE,this.penetrable=!0,this.hp=hp,this.color=-1,this.updateType();break;case ItemType.CHERRY:this.targetId=Target.CHERRY,this.exchangeable=!1,this.movable=!1,this.clearType=ClearType.NEXT,this.penetrable=!0,this.hp=hp,this.color=-1,this.updateType();break;case ItemType.BISCUIT:this.targetId=Target.BISCUIT,this.exchangeable=!0,this.movable=!0,this.clearType=ClearType.NEXT_NOT_PROPS,this.penetrable=!1,this.hp=hp,this.color=-1,this.updateType();break;case ItemType.WALNUT:this.targetId=Target.WALNUT,this.exchangeable=!1,this.movable=!0,this.clearType=ClearType.ONLY_PROPS,this.penetrable=!0,this.hp=hp,this.color=-1,this.updateType();break;default:type>100?(this.beProps(),this.updateType()):Log.log("没有这样的形态")}}useProps(exchangeId,withOutArr,wait=!1){return this.type<100||2!=this.hp?[]:(this.hp--,Props.useProps(this.id,exchangeId,this.type,withOutArr,wait))}beProps(){this.movable=!0,this.exchangeable=!0,this.clearType=ClearType.SELF,this.penetrable=!0,this.color=-1,this.targetId=this.color,this.hp=2}updateType(){if(this.removeChildren(),this.type>200)this.type!=ItemType.BOMB_BALL&&this.type!=ItemType.PLANE_BALL&&this.type!=ItemType.ROCKET_BALL||(this.skin=null,EffectManager.Instance.playGif(this,PropsEffectList.ball_idle));else switch(this.addShapeImg(this.type,this.hp),this.skin=null,this.type){case ItemType.PLANE:EffectManager.Instance.playGif(this,PropsEffectList.plane_idle);break;case ItemType.BALL:EffectManager.Instance.playGif(this,PropsEffectList.ball_idle);break;case ItemType.HENG:EffectManager.Instance.playGif(this,PropsEffectList.rocket_idle,-90);break;case ItemType.SHU:EffectManager.Instance.playGif(this,PropsEffectList.rocket_idle);break;case ItemType.BOMB:EffectManager.Instance.playGif(this,PropsEffectList.bomb_idle);break;default:this.skin=ResConfig.getItemUrl(this.type,this.hp,this.color)}}addShapeImg(type,hp){let img=new Laya.Image,skin=ResConfig.getShapeImgUrl(type,hp);""!=skin&&(img.skin=skin,img.width=this.width,img.height=this.height,this.addChild(img))}moveToIdPos(id,tweenTime=Global.TWEENTIME,callback){this.id=id,this.posX=id%GameData.ins.col,this.posY=Math.floor(id/GameData.ins.col),AniManager.moveToIdPosAni(this,this.posX*this.width,this.posY*this.height,tweenTime,callback),this.type==ItemType.DONUT&&(1==ChessBoard.ins.otherArr[this.id].isBottom?this.clearType=ClearType.SELF:this.clearType=ClearType.UNABLE)}throughPortal(id,tweenTime,callback){AniManager.moveToIdPosAni(this,this.posX*this.width,(this.posY+1)*this.height,tweenTime,Laya.Handler.create(this,()=>{this.id=id,this.posX=id%GameData.ins.col,this.posY=Math.floor(id/GameData.ins.col),this.x=this.posX*this.width,this.y=(this.posY-1)*this.height,AniManager.moveToIdPosAni(this,this.posX*this.width,this.posY*this.height,tweenTime,callback)}))}changeToSpace(){this.movable=!0,this.exchangeable=!0,this.clearType=ClearType.SELF,this.penetrable=!0,this.color=null,this.skin=null}playAni(){switch(this.type){case ItemType.CHERRY:1==this.hp?AniManager.playEffect(EffectList.chuanghu1,this.id):2==this.hp&&AniManager.playEffect(EffectList.chuanghu2,this.id);break;case ItemType.SUGER:2==this.hp?AniManager.playEffect(EffectList.chuanghu1,this.id):3==this.hp&&AniManager.playEffect(EffectList.chuanghu2,this.id);break;case ItemType.BISCUIT:1==this.hp?AniManager.playEffect(EffectList.jiutan1,this.id):2==this.hp&&AniManager.playEffect(EffectList.jiutan2,this.id);break;case ItemType.LOCKED:2==this.hp?AniManager.playEffect(EffectList.kuaizi1,this.id):3==this.hp&&AniManager.playEffect(EffectList.kuaizi2,this.id);break;case ItemType.BOX:1==this.hp?AniManager.playEffect(EffectList.xiangzi1,this.id):2==this.hp&&AniManager.playEffect(EffectList.xiangzi2,this.id)}}setSelect(isSelect){this.isSelect=isSelect,this.alpha=isSelect?.5:1}playBallSelectAni(skin){this.skeleton=EffectManager.Instance.propsTemplets[skin].buildArmature(0),this.skeleton.pos(GameData.ins.IconW/2,GameData.ins.IconH/2),this.skeleton.scale(Global.scale,Global.scale),skin==PropsEffectList.bomb4?(this.skeleton.play(0,!1),this.skeleton.on(Laya.Event.STOPPED,this,()=>{this.skeleton.play("play2",!0)})):this.skeleton.play(0,!0),this.addChild(this.skeleton)}stopPlayBallSelectAni(){null!=this.skeleton&&(this.skeleton.stop(),this.skeleton.removeSelf(),this.skeleton=null)}setTips(direction){this.isTipsItem=!0,Laya.timer.once(5e3,this,()=>{Laya.timer.loop(2e3,this,this.doTipsAni,[direction])})}clearTipsItem(){this.isTipsItem=!1,Laya.timer.clearAll(this),Laya.Tween.clearAll(this),this.x=this.posX*this.width,this.y=this.posY*this.height}doTipsAni(direction){let idX=this.x,idY=this.y,tempX=this.x,tempY=this.y,distance=GameData.ins.IconH/5;switch(direction){case Direction.UP:tempY-=distance;break;case Direction.DOWN:tempY+=distance;break;case Direction.LEFT:tempX-=distance;break;case Direction.RIGHT:tempX+=distance}Laya.Tween.to(this,{x:tempX,y:tempY},150,Laya.Ease.linearIn,Laya.Handler.create(this,()=>{Laya.Tween.to(this,{x:idX,y:idY},150,Laya.Ease.linearIn,Laya.Handler.create(this,()=>{Laya.Tween.to(this,{x:tempX,y:tempY},150,Laya.Ease.linearIn,Laya.Handler.create(this,()=>{Laya.Tween.to(this,{x:idX,y:idY},150,Laya.Ease.linearIn)}))}))}))}recover(){this.removeSelf(),this.destroy()}}class Back extends Laya.Image{constructor(id,x,y,type=BackType.NORMAL){super(),this.id=id,this.type=type,this.posX=x,this.posY=y,this.backBoardArr=[0,0,0,0],this.init()}init(){this.width=GameData.ins.IconW,this.height=GameData.ins.IconH,this.x=this.posX*this.width,this.y=this.posY*this.height,this.updateSkin()}updateSkin(){switch(this.type){case BackType.DEAD:this.skin=null;break;case BackType.NORMAL:this.skin=ResConfig.getBoardURL("back_normal.jpg");break;case BackType.GRASS:this.skin=ResConfig.getBoardURL("back_normal.jpg"),this.imgGrass=new Laya.Image(ResConfig.IMGURL+"back_grass.jpg"),this.imgGrass.height=this.height,this.imgGrass.width=this.width,this.addChild(this.imgGrass)}}changeType(type){this.type!=type&&(this.type=type,this.updateSkin(),type==BackType.GRASS&&(ChessBoard.ins.addTargetItem(Target.GRASS),AniManager.playBeGrassAni(this.imgGrass,Laya.Handler.create(this,()=>{EventHandler.Dispatch(EventName.UPDATE_TARGET_NUM)}))))}addBackBoard(){0!=this.posY&&ChessBoard.ins.backArr[this.id-GameData.ins.col].type!=BackType.DEAD||(this.backBoardArr[0]=1),this.posX!=GameData.ins.col-1&&ChessBoard.ins.backArr[this.id+1].type!=BackType.DEAD||(this.backBoardArr[1]=1),this.posY!=GameData.ins.row-1&&ChessBoard.ins.backArr[this.id+GameData.ins.col].type!=BackType.DEAD||(this.backBoardArr[2]=1),0!=this.posX&&ChessBoard.ins.backArr[this.id-1].type!=BackType.DEAD||(this.backBoardArr[3]=1);let sum=0;for(let i=0;i<this.backBoardArr.length;i++)sum+=this.backBoardArr[i];if(0!=sum)for(let i=0;i<this.backBoardArr.length;i++)if(1==this.backBoardArr[i]){let targetId;switch(i){case 0:targetId=this.id-GameData.ins.col-1,this.posX>0&&this.posY>0&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?(Utils.addInAngle(this,i,0),Utils.addEdge(this,i,0,1)):1==this.backBoardArr[i+3]?Utils.addEdge(this,i,0,2):Utils.addEdge(this,i,0),targetId=this.id-GameData.ins.col+1,this.posX<GameData.ins.col-1&&this.posY>0&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?(Utils.addInAngle(this,i,1),Utils.addEdge(this,i,1,1)):1==this.backBoardArr[i+1]?(Utils.addOutAngle(this,i+1),Utils.addEdge(this,i,1,2)):Utils.addEdge(this,i,1);break;case 1:targetId=this.id-GameData.ins.col+1,this.posX<GameData.ins.col-1&&this.posY>0&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?(Utils.addInAngle(this,i,0),Utils.addEdge(this,i,0,1)):1==this.backBoardArr[i-1]?Utils.addEdge(this,i,0,2):Utils.addEdge(this,i,0),targetId=this.id+GameData.ins.col+1,this.posX<GameData.ins.col-1&&this.posY<GameData.ins.row-1&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?Utils.addEdge(this,i,1,1):1==this.backBoardArr[i+1]?(Utils.addOutAngle(this,i+1),Utils.addEdge(this,i,1,2)):Utils.addEdge(this,i,1);break;case 2:targetId=this.id+GameData.ins.col+1,this.posX<GameData.ins.col-1&&this.posY<GameData.ins.row-1&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?(Utils.addInAngle(this,i,0),Utils.addEdge(this,i,0,1)):1==this.backBoardArr[i-1]?Utils.addEdge(this,i,0,2):Utils.addEdge(this,i,0),targetId=this.id+GameData.ins.col-1,this.posX>0&&this.posY<GameData.ins.row-1&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?Utils.addEdge(this,i,1,1):1==this.backBoardArr[i+1]?(Utils.addOutAngle(this,i+1),Utils.addEdge(this,i,1,2)):Utils.addEdge(this,i,1);break;case 3:targetId=this.id+GameData.ins.col-1,this.posX>0&&this.posY<GameData.ins.row-1&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?Utils.addEdge(this,i,0,1):1==this.backBoardArr[i-1]?Utils.addEdge(this,i,0,2):Utils.addEdge(this,i,0),targetId=this.id-GameData.ins.col-1,this.posX>0&&this.posY>0&&ChessBoard.ins.backArr[targetId].type!=BackType.DEAD?(Utils.addInAngle(this,i,1),Utils.addEdge(this,i,1,1)):1==this.backBoardArr[0]?(Utils.addOutAngle(this,0),Utils.addEdge(this,i,1,2)):Utils.addEdge(this,i,1)}}}playBombAni(){this.type!=BackType.DEAD&&AniManager.playBombAni(this,PropsEffectList.bomb3)}}class Other extends Laya.Image{constructor(id,x,y,isTop=!1,isBottom=!1,portalNum=0,guardArr=[0,0,0,0]){super(),this.guardArr=[0,0,0,0],this.id=id,this.posX=x,this.posY=y,this.isTop=isTop,this.isBottom=isBottom,this.portalNum=portalNum;for(let i=0;i<guardArr.length;i++)this.guardArr[i]=guardArr[i];this.init()}init(){this.width=GameData.ins.IconW,this.height=GameData.ins.IconH,this.x=this.posX*this.width,this.y=this.posY*this.height,this.isBottom&&EffectManager.Instance.playGif(this,PropsEffectList.wuxianjiantou)}addPortal(){this.portalNum>0?EffectManager.Instance.playGif(this,PropsEffectList.rukou):this.portalNum<0&&EffectManager.Instance.playGif(this,PropsEffectList.chukou)}addGuard(){for(let i=0;i<this.guardArr.length;i++)if(1==this.guardArr[i]){let img=new Laya.Image(ResConfig.IMGURL+"guard.png"),scale=this.width/img.width;switch(img.height=img.height*scale,img.width=img.width*scale,img.rotation=90*i,i){case 0:img.name="topGuard",img.x=0,img.y=-img.height/2;break;case 1:img.name="rightGuard",img.x=img.width+img.height/2,img.y=0;break;case 2:img.name="bottomGuard",img.x=img.width,img.y=this.height+img.height/2;break;case 3:img.name="leftGuard",img.x=-img.height/2,img.y=img.width}this.addChild(img)}}removeGuard(index){this.guardArr[index]=0;let name="";switch(index){case 0:name="topGuard";break;case 1:name="rightGuard";break;case 2:name="bottomGuard";break;case 3:name="leftGuard"}this.removeChildByName(name)}}var ui,GameState,REG=Laya.ClassUtils.regClass;!function(ui){class BoardUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(BoardUI.uiView)}}BoardUI.uiView={type:"Scene",props:{width:750,height:800},compId:2,child:[{type:"Box",props:{y:0,width:720,var:"backPanel",height:800,centerX:0},compId:3},{type:"Box",props:{y:0,width:720,var:"itemPanel",height:800,centerX:0},compId:4},{type:"Box",props:{y:0,width:720,var:"otherPanel",height:800,centerX:0},compId:5}],loadList:[],loadList3D:[]},ui.BoardUI=BoardUI,REG("ui.BoardUI",BoardUI);class CommonDlgUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(CommonDlgUI.uiView)}}CommonDlgUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{y:0,x:0,width:750,skin:"dlg/black.png",height:1624,alpha:.8},compId:15},{type:"Image",props:{top:285,skin:"dlg/tips.png",centerX:0},compId:14},{type:"Label",props:{y:375,wordWrap:!0,width:410,var:"title",valign:"middle",text:"恭喜你通关",styleSkin:"comp/label.png",height:341,fontSize:36,color:"#5f3d13",centerX:0,align:"center"},compId:6},{type:"Button",props:{y:722.5,var:"btnLeft",stateNum:1,skin:"dlg/btn_confirm.png",labelSize:36,labelColors:"#fff",centerX:0},compId:4},{type:"Button",props:{y:335,x:624,visible:!1,var:"btn_back",stateNum:1,skin:"dlg/btn_close2.png"},compId:13}],loadList:["dlg/black.png","dlg/tips.png","comp/label.png","dlg/btn_confirm.png","dlg/btn_close2.png"],loadList3D:[]},ui.CommonDlgUI=CommonDlgUI,REG("ui.CommonDlgUI",CommonDlgUI);class GameUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(GameUI.uiView)}}GameUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{skin:"board/bg_board.jpg"},compId:37,child:[{type:"Label",props:{y:306,x:337,width:76,var:"lab_level",text:"1",height:33,fontSize:36,color:"#bd823d",bold:!0,align:"center"},compId:24}]},{type:"Box",props:{width:400,top:168,height:115,centerX:-2},compId:25,child:[{type:"Box",props:{y:6,x:55},compId:22,child:[{type:"Image",props:{y:0,x:1,skin:"board/step.png"},compId:21},{type:"Label",props:{y:16,x:17,width:62,var:"step",text:"0",height:32,fontSize:32,color:"#ffbc84",bold:!0,align:"center"},compId:10}]},{type:"Box",props:{y:0,x:170,width:200,var:"targetBox",height:99},compId:12}]},{type:"Button",props:{var:"btnBack",top:26,stateNum:1,skin:"board/back.png",left:26,labelSize:28},compId:15},{type:"Button",props:{y:307.5,x:110,width:100,var:"btnCheat",labelSize:32,label:"作弊开",height:50},compId:26},{type:"TextInput",props:{y:332.5,x:573,width:56,var:"txtLevel",prompt:"关卡",height:32,fontSize:18},compId:30},{type:"Button",props:{y:329,x:633,width:49,var:"btnJump",labelSize:24,label:"跳转",height:39},compId:31},{type:"Text",props:{y:1156,x:746,width:134,var:"txtSgs",text:"©2021 三国杀",pivotY:18,pivotX:134,height:18,fontSize:20,font:"Microsoft YaHei",color:"#ffffff",runtime:"laya.display.Text"},compId:39}],loadList:["board/bg_board.jpg","board/step.png","board/back.png"],loadList3D:[]},ui.GameUI=GameUI,REG("ui.GameUI",GameUI);class GuideTipsUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(GuideTipsUI.uiView)}}GuideTipsUI.uiView={type:"Scene",props:{width:750,height:100},compId:2,child:[{type:"Image",props:{y:0,width:650,var:"bg",skin:"dlg/bubble.jpg",height:100,centerX:0},compId:3},{type:"Label",props:{y:9.5,x:75.5,wordWrap:!0,width:599,var:"txt",valign:"middle",text:"让四个图案相连试试",height:81,fontSize:32,bold:!1,align:"center"},compId:4}],loadList:["dlg/bubble.jpg"],loadList3D:[]},ui.GuideTipsUI=GuideTipsUI,REG("ui.GuideTipsUI",GuideTipsUI);class LevelClearDlgUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(LevelClearDlgUI.uiView)}}LevelClearDlgUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{y:0,x:0,width:750,skin:"dlg/black.png",height:1624,alpha:.8},compId:21},{type:"SkeletonPlayer",props:{y:770,x:375,url:"dlg/spine/Xyx_victory_fireworks.sk",runtime:"laya.ani.bone.Skeleton"},compId:25},{type:"Image",props:{y:200,x:0,var:"main",skin:"dlg/win.png"},compId:15,child:[{type:"Box",props:{y:542,width:304,var:"starBox",height:190,centerX:10},compId:10},{type:"Button",props:{y:760,var:"btn_next",stateNum:1,skin:"dlg/btn_next.png",labelSize:28,centerX:19},compId:8},{type:"Image",props:{y:883,x:252,var:"ewai",skin:"dlg/ewai.png"},compId:19,child:[{type:"Label",props:{y:1,x:122,wordWrap:!0,width:165,var:"txt_prizes",valign:"top",styleSkin:"comp/label.png",height:28,fontSize:26,font:"Microsoft YaHei",color:"#fee48f",bold:!0,align:"center"},compId:7}]}]},{type:"Button",props:{y:0,var:"btn_back",stateNum:1,skin:"dlg/btn_close2.png",scaleY:1,scaleX:1,right:50},compId:13}],loadList:["dlg/black.png","dlg/spine/Xyx_victory_fireworks.sk","dlg/win.png","dlg/btn_next.png","dlg/ewai.png","comp/label.png","dlg/btn_close2.png"],loadList3D:[]},ui.LevelClearDlgUI=LevelClearDlgUI,REG("ui.LevelClearDlgUI",LevelClearDlgUI);class LevelFailDlgUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(LevelFailDlgUI.uiView)}}LevelFailDlgUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{y:0,x:0,width:750,skin:"dlg/black.png",height:1624,alpha:.8},compId:21},{type:"SkeletonPlayer",props:{y:594,x:361,url:"dlg/spine/Xyx_lose_snow.sk",scaleY:2,scaleX:2,runtime:"laya.ani.bone.Skeleton"},compId:27},{type:"Image",props:{y:200,x:0,var:"main",skin:"dlg/lose.png"},compId:17,child:[{type:"Label",props:{y:435,x:260,width:43,var:"hpNum",valign:"middle",text:"5",height:38,fontSize:20,color:"#f9e291",bold:!0,align:"center"},compId:14},{type:"Button",props:{y:605,var:"btn_again",stateNum:1,skin:"dlg/btn_again.png",labelSize:28,centerX:9},compId:5},{type:"Button",props:{y:691,var:"btn_help",stateNum:1,skin:"dlg/btn_help.png",labelSize:28,centerX:9},compId:16},{type:"Panel",props:{y:492,width:235,var:"targetPanel",height:122,centerX:3},compId:10},{type:"Text",props:{y:779,x:224,width:304,var:"txt_prizes",valign:"middle",height:42,fontSize:24,font:"Microsoft YaHei",color:"#f9e291",align:"center",runtime:"laya.display.Text"},compId:20}]},{type:"Button",props:{y:0,var:"btn_back",stateNum:1,skin:"dlg/btn_close2.png",scaleY:1,scaleX:1,right:49},compId:15}],loadList:["dlg/black.png","dlg/spine/Xyx_lose_snow.sk","dlg/lose.png","dlg/btn_again.png","dlg/btn_help.png","dlg/btn_close2.png"],loadList3D:[]},ui.LevelFailDlgUI=LevelFailDlgUI,REG("ui.LevelFailDlgUI",LevelFailDlgUI);class NewStartViewUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(NewStartViewUI.uiView)}}NewStartViewUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{y:0,x:0,width:750,skin:"dlg/black.png",height:1624,alpha:.8},compId:12},{type:"Image",props:{top:245,skin:"dlg/start.png",centerX:0},compId:3,child:[{type:"Button",props:{y:468,var:"btnStart",stateNum:1,skin:"dlg/btn_start.png",centerX:0},compId:4},{type:"Panel",props:{y:218,width:235,var:"targetPanel",height:122,centerX:0},compId:5},{type:"Label",props:{y:38,width:68,var:"labLevel",valign:"middle",height:42,fontSize:42,color:"#ffe8ab",centerX:0,bold:!0,align:"center"},compId:6},{type:"Label",props:{y:417,x:170,width:410,var:"tips",valign:"middle",text:"有的障碍物需要消除多次，耐心点吧！",height:42,fontSize:24,font:"SimHei",color:"#8b5016",centerX:0,bold:!1,align:"center"},compId:7},{type:"Button",props:{y:29,var:"btnBack",stateNum:1,skin:"dlg/btn_close.png",right:37},compId:11}]}],loadList:["dlg/black.png","dlg/start.png","dlg/btn_start.png","dlg/btn_close.png"],loadList3D:[]},ui.NewStartViewUI=NewStartViewUI,REG("ui.NewStartViewUI",NewStartViewUI);class TargetUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(TargetUI.uiView)}}TargetUI.uiView={type:"Scene",props:{width:80,height:99},compId:2,child:[{type:"Image",props:{y:4,width:66,var:"img",skin:"icon/1.png",height:66,centerX:0},compId:4},{type:"Label",props:{x:0,width:80,var:"labNum",valign:"middle",text:"0",height:32,fontSize:24,color:"#ffbc84",bottom:-2,bold:!0,align:"center"},compId:5}],loadList:["icon/1.png"],loadList3D:[]},ui.TargetUI=TargetUI,REG("ui.TargetUI",TargetUI);class TargetForStartUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(TargetForStartUI.uiView)}}TargetForStartUI.uiView={type:"Scene",props:{width:80,height:120},compId:2,child:[{type:"Image",props:{y:4,width:80,var:"img",skin:"icon/1.png",height:80,centerX:0},compId:4},{type:"Label",props:{x:0,width:80,var:"labNum",valign:"middle",text:"0",height:32,fontSize:30,color:"#ffbc84",bottom:-2,bold:!0,align:"center"},compId:5}],loadList:["icon/1.png"],loadList3D:[]},ui.TargetForStartUI=TargetForStartUI,REG("ui.TargetForStartUI",TargetForStartUI);class TipsDlgUI extends Laya.Scene{constructor(){super()}createChildren(){super.createChildren(),this.createView(TipsDlgUI.uiView)}}TipsDlgUI.uiView={type:"Scene",props:{width:750,height:1624},compId:2,child:[{type:"Image",props:{visible:!0,var:"bg",top:285,skin:"dlg/tips.png",centerX:0},compId:11},{type:"Label",props:{wordWrap:!0,width:404,var:"title",valign:"middle",text:"恭喜你通关",styleSkin:"comp/label.png",height:331,fontSize:36,color:"#5f3d13",centerY:-267,centerX:0,bold:!1,align:"center"},compId:5}],loadList:["dlg/tips.png","comp/label.png"],loadList3D:[]},ui.TipsDlgUI=TipsDlgUI,REG("ui.TipsDlgUI",TipsDlgUI)}(ui||(ui={}));class TargetView extends ui.TargetUI{constructor(type,num,color=""){switch(super(),this.type=type,this.num=num,this.type){case Target.RED:case Target.YELLOW:case Target.GREEN:case Target.PINK:case Target.BLUE:this.img.skin=ResConfig.getItemUrl(ItemType.NORMAL,null,this.type);break;case Target.DONUT:this.img.skin=ResConfig.getItemUrl(ItemType.DONUT);break;case Target.CHERRY:this.img.skin=ResConfig.getItemUrl(ItemType.CHERRY,0);break;case Target.GRASS:this.img.skin=ResConfig.IMGURL+"back_grass2.png";break;case Target.BISCUIT:this.img.skin=ResConfig.getItemUrl(ItemType.BISCUIT,1);break;case Target.BOX:this.img.skin=ResConfig.getItemUrl(ItemType.BOX,1)}this.labNum.text=""+num,""!=color&&(this.labNum.color=color)}updateTargetNum(){this.num<0&&(this.num=0),this.labNum.text=""+this.num}}class BoardView extends ui.BoardUI{constructor(roomId){super(),this.x=roomId*(this.width+100),this.y=Global.boardHeight,this.x+=GameData.ins.offsetX,this.itemPanel.width*=Global.scale,this.backPanel.width*=Global.scale,this.otherPanel.width*=Global.scale}}!function(GameState){GameState[GameState.GS_READY=0]="GS_READY",GameState[GameState.GS_WAITE=1]="GS_WAITE",GameState[GameState.GS_PLAYING=2]="GS_PLAYING",GameState[GameState.GS_OVER=3]="GS_OVER"}(GameState||(GameState={}));class PlarLevelManager{static saveLevelInfo(data){Global.isOffline&&localStorage.setItem(StorageConfig.PLAYER_LEVEL,data)}static getLevelInfo(){if(!Global.isOffline)return;let info=JSON.parse(localStorage.getItem(StorageConfig.PLAYER_LEVEL));if(null==info){info={level:{}};for(let i=1;i<=Global.maxLevel;i++)info.level[i]={start:0,lose:0,win:0,step:null}}return info}static levelUpdate(type,levelId){if(!Global.isOffline)return;let info=PlarLevelManager.getLevelInfo();switch(null==info.level[levelId]&&(info.level[levelId]={start:0,lose:0,win:0,step:null}),type){case"start":info.level[levelId].start++;break;case"win":info.level[levelId].win++,null==info.level[levelId].step?info.level[levelId].step=ChessBoard.ins.step:info.level[levelId].step=Math.floor(info.level[levelId].step+ChessBoard.ins.step)/2;break;case"lose":info.level[levelId].lose++}PlarLevelManager.saveLevelInfo(JSON.stringify(info))}}class TargetForStartView extends ui.TargetForStartUI{constructor(type,num,color=""){switch(super(),this.type=type,this.num=num,this.type){case Target.RED:case Target.YELLOW:case Target.GREEN:case Target.PINK:case Target.BLUE:this.img.skin=ResConfig.getItemUrl(ItemType.NORMAL,null,this.type);break;case Target.DONUT:this.img.skin=ResConfig.getItemUrl(ItemType.DONUT);break;case Target.CHERRY:this.img.skin=ResConfig.getItemUrl(ItemType.CHERRY,0);break;case Target.GRASS:this.img.skin=ResConfig.IMGURL+"back_grass2.png";break;case Target.BISCUIT:this.img.skin=ResConfig.getItemUrl(ItemType.BISCUIT,1);break;case Target.BOX:this.img.skin=ResConfig.getItemUrl(ItemType.BOX,1)}this.labNum.text=""+num,""!=color&&(this.labNum.color=color)}updateTargetNum(){this.num<0&&(this.num=0),this.labNum.text=""+this.num}}class NewStartView extends ui.NewStartViewUI{constructor(){super()}show(){this.btnStart.on(Laya.Event.CLICK,this,this.onClickBtnStart),this.btnBack.on(Laya.Event.CLICK,Utils,Utils.back),this.upDateUI(),Laya.stage.addChild(this)}hide(){this.btnStart.off(Laya.Event.CLICK,this,this.onClickBtnStart),this.btnBack.off(Laya.Event.CLICK,Utils,Utils.back),this.removeSelf()}upDateUI(){this.labLevel.text=""+GameData.ins.levelId;let ran=Math.floor(Math.random()*Global.tips.length);this.tips.text=Global.tips[ran],this.targetPanel.removeChildren();let target=GameData.ins.target;if(target){let k=0;if(1==target.targetDataArr.length){let targetForStartView=new TargetForStartView(target.targetDataArr[0].type,target.targetDataArr[0].num,"#950808");targetForStartView.x=77,this.targetPanel.addChild(targetForStartView)}else if(2==target.targetDataArr.length){let targetForStartView1=new TargetForStartView(target.targetDataArr[0].type,target.targetDataArr[0].num,"#950808");this.targetPanel.addChild(targetForStartView1);let targetForStartView2=new TargetForStartView(target.targetDataArr[1].type,target.targetDataArr[1].num,"#950808");targetForStartView2.x=155,this.targetPanel.addChild(targetForStartView2)}else for(let i=0;i<target.targetDataArr.length;i++){let targetForStartView=new TargetForStartView(target.targetDataArr[i].type,target.targetDataArr[i].num,"#950808");targetForStartView.x=k%2*120,targetForStartView.y=120*Math.floor(k/2),this.targetPanel.addChild(targetForStartView),k++}}}onClickBtnStart(){if(Global.isOffline)return PlarLevelManager.levelUpdate("start",GameData.ins.levelId),void MainGameManager.ins.hideTargetDlg();this.btnStart.off(Laya.Event.CLICK,this,this.onClickBtnStart);let data={level:0!=PlayerManager.ins.user.assistLevel?PlayerManager.ins.user.assistLevel:PlayerManager.ins.user.level,code:PlayerManager.ins.user.code};HttpClient.instance.request(EnumCmdName.START,data,!0,Laya.Handler.create(this,this.onClickBtnStartOK))}onClickBtnStartOK(data){this.btnStart.on(Laya.Event.CLICK,this,this.onClickBtnStart),Log.log("收到服务端消息，开始游戏",data),0==data.ret?(MainGameManager.ins.hideTargetDlg(),PlayerManager.ins.user.assistLevel=0,PlayerManager.ins.user.code="",PlayerManager.ins.user.token=data.data.token):(alert(data.error),Log.log(data.error))}}class CommonDlg extends ui.CommonDlgUI{constructor(title,left,callBackLeft,back=!1){switch(super(),this.title.text=title,left){case"确认":this.btnLeft.skin=ResConfig.getDlgURL("btn_confirm.png");break;case"退出":this.btnLeft.skin=ResConfig.getDlgURL("btn_exit.png")}this.callBackLeft=callBackLeft,this.btn_back.visible=!!back,this.btnLeft.on(Laya.Event.CLICK,this,this.onClickBtnLeft),this.btn_back.on(Laya.Event.CLICK,this,this.onClickBtnBack)}onClickBtnLeft(){this.callBackLeft&&this.callBackLeft.run(),this.removeSelf()}onClickBtnBack(){this.removeSelf()}}class GuideTips extends ui.GuideTipsUI{constructor(txt,height){switch(super(),this.txt.text=txt,height){case 0:this.x=10,this.y=300;break;case 1:this.x=10,this.y=600;break;case 2:this.x=10,this.y=800}}}class MainGameView extends ui.GameUI{show(levelId){Laya.stage.addChild(this),this.count=0,this.targetArr=[],this.panelArr=[],MainGameManager.ins.gameState=GameState.GS_WAITE,this.commitSuccess=!1,this.commitTimerId&&(clearInterval(this.commitTimerId),this.commitTimerId=null),this.lab_level.text=""+levelId,this.txtSgs.y=Laya.stage.height-10,this.txtSgs.zOrder=100,EventHandler.AddListener(EventName.CHANGE_ORDER,this,this.showChangeOrderTips),EventHandler.AddListener(EventName.ADD_ITEM,this,this.addItem),EventHandler.AddListener(EventName.UPDATE_STEP,this,this.updateStep),EventHandler.AddListener(EventName.UPDATE_TARGET_NUM,this,this.updateTargetNum),EventHandler.AddListener(EventName.LEVEL_CLEAR,this,this.onGameWin),EventHandler.AddListener(EventName.LEVEL_FAILED,this,this.onGameLose),EventHandler.AddListener(EventName.E_Visibility_Background,this,this.onEnterBackground),EventHandler.AddListener(EventName.E_Visibility_Foreground,this,this.onEnterForeground),this.btnBack.on(Laya.Event.CLICK,this,this.onClickBtnBack),this.btnCheat.on(Laya.Event.CLICK,this,this.onClickBtnCheat),this.btnJump.on(Laya.Event.CLICK,this,this.onClickBtnJump),this.btnCheat.visible=Global.isOffline,this.txtLevel.visible=Global.isOffline,this.btnJump.visible=Global.isOffline,this.initGame(),this.showGuide(levelId),this.showTargetDlg()}hide(){EventHandler.RemoveListener(EventName.CHANGE_ORDER,this,this.showChangeOrderTips),EventHandler.RemoveListener(EventName.ADD_ITEM,this,this.addItem),EventHandler.RemoveListener(EventName.UPDATE_STEP,this,this.updateStep),EventHandler.RemoveListener(EventName.UPDATE_TARGET_NUM,this,this.updateTargetNum),EventHandler.RemoveListener(EventName.LEVEL_CLEAR,this,this.onGameWin),EventHandler.RemoveListener(EventName.LEVEL_FAILED,this,this.onGameLose),EventHandler.RemoveListener(EventName.E_Visibility_Background,this,this.onEnterBackground),EventHandler.RemoveListener(EventName.E_Visibility_Foreground,this,this.onEnterForeground),ChessBoard.ins.stopTween(),this.stopTween(),this.clearChessBoard(),this.clearTarget(),this.removeSelf()}initGame(){this.initChessBoard()}initChessBoard(){this.initTarget();for(let i=0;i<GameData.ins.roomArr.length;i++){let panel=new BoardView(i);this.panelArr.push(panel),this.addChild(panel)}ChessBoard.ins.init(),ChessBoard.ins.initItemArr(0);let leftImg=new Laya.Image("board/left.jpg"),rightImg=new Laya.Image("board/right.jpg");leftImg.left=0,leftImg.top=370.5,rightImg.right=0,rightImg.top=370.5,this.addChild(leftImg),this.addChild(rightImg),this.showChessBoard()}onGameWin(){this.result=1,this.gameOver()}onGameLose(){this.result=0,this.gameOver()}gameOver(){if(MainGameManager.ins.gameState!=GameState.GS_OVER)if(MainGameManager.ins.gameState=GameState.GS_OVER,Global.isOffline){let hp=this.result?PlayerManager.ins.user.hp:--PlayerManager.ins.user.hp,result={win:this.result,reward:{game:{name:"开黑宝盒*2",prize_id:10,num:1},star:1},life:hp,level:GameData.ins.levelId,assist:0};PlayerManager.ins.updateLocalResult(result);let data={ret:0,data:result};Laya.timer.once(0,this,this.onGameOverOK,[data])}else{let data={win:this.result,step:GameData.ins.step-ChessBoard.ins.step};HttpClient.instance.request(EnumCmdName.END,data,!0,Laya.Handler.create(MainGameManager.ins,MainGameManager.ins.gameOver),Laya.Handler.create(this,this.requsetGameOverError),Laya.Handler.create(this,this.requsetGameOverTimeOut))}}closeTipDlg(){this.tipDlg&&(this.tipDlg.close(),this.tipDlg=null)}onGameOverOK(data){MainGameManager.ins.gameState==GameState.GS_OVER&&(this.commitSuccess=!0,Log.log("请求游戏结果成功",data),this.showGameOverDlg(data),Global.isOffline||data&&data.data&&0==data.ret&&PlayerManager.ins.updateResult(data.data))}onGameOverError(data){MainGameManager.ins.gameState==GameState.GS_OVER&&(this.commitSuccess=!0,this.closeTipDlg(),this.showErrorDlg("","\n"+data.error),Log.log("请求游戏结果失败"))}requsetGameOverError(e){this.closeTipDlg(),MainGameManager.ins.gameState!=GameState.GS_OVER||this.commitSuccess||this.showErrorDlg(e,"结算异常")}requsetGameOverTimeOut(e){this.closeTipDlg(),MainGameManager.ins.gameState!=GameState.GS_OVER||this.commitSuccess||this.showErrorDlg("网络异常\n","结算失败")}showGameOverDlg(data){Laya.timer.once(200,this,()=>{if(this.closeTipDlg(),data)if(0==data.ret){let prize_id,prize_name;data.data.reward.game?(prize_id=data.data.reward.game.prize_id,prize_name=data.data.reward.game.name):(prize_id=null,prize_name=null),MainGameManager.ins.levelComplete({win:data.data.win,assist:data.data.assist,prize_id:prize_id,prize_name:prize_name,hp:data.data.life,level:data.data.level,star:data.data.reward.star})}else Log.log(data.error),this.showErrorDlg("",data.error)})}showErrorDlg(title,error){let tips=new CommonDlg(title+error,"确定",Laya.Handler.create(MainGameManager.ins,MainGameManager.ins.back));Laya.stage.addChild(tips)}onEnterBackground(){Log.log("切到后台了"),SoundManager.instance.pauseMusic()}onEnterForeground(){Log.log("切回前台了"),SoundManager.instance.resumeMusic()}showGuide(levelId,step=1){let data=GuideConfig.getGuideByLevel(levelId,step);if(null==data)return void(ChessBoard.ins.isGuideStep=0);this.blackBg=new Laya.Image("dlg/black.png"),this.blackBg.width=750,this.blackBg.height=1624,this.blackBg.alpha=.8,this.blackBg.cacheAs="bitmap",this.blackBg.mouseEnabled=!1,this.addChild(this.blackBg);for(let i=0;i<data.mask.length;i++){let id=data.mask[i].id,idX=ChessBoard.ins.itemArr[id].x+GameData.ins.offsetX+15+720*(1-Global.scale)/2,idY=ChessBoard.ins.itemArr[id].y+Global.boardHeight,rMask=new Laya.Sprite;rMask.graphics.drawRect(idX,idY,data.mask[i].width,data.mask[i].height,"#000000"),rMask.blendMode="destination-out",this.blackBg.addChild(rMask)}data.tips&&ChessBoard.ins.setTips(data.tips[0],data.tips[1]);let tipsId=data.tipsId;this.guideTips=new GuideTips(data.txt,tipsId),1==step&&(this.guideTips.visible=!1,this.blackBg.alpha=0),this.addChild(this.guideTips)}hideGuide(){this.blackBg&&(this.blackBg.removeSelf(),this.blackBg=null),this.guideTips&&(this.guideTips.removeSelf(),this.guideTips=null),Laya.timer.once(Global.CLEARTWEENTIME,this,()=>{this.showGuide(GameData.ins.levelId,ChessBoard.ins.isGuideStep)})}updateStep(){Log.log("更新步数");let step=ChessBoard.ins.step;this.step.text=""+step}showChessBoard(){for(let i=0;i<ChessBoard.ins.itemArr.length;i++)this.panelArr[ChessBoard.ins.curRoomId].backPanel.addChild(ChessBoard.ins.backArr[i]),this.panelArr[ChessBoard.ins.curRoomId].itemPanel.addChild(ChessBoard.ins.itemArr[i]),this.panelArr[ChessBoard.ins.curRoomId].otherPanel.addChild(ChessBoard.ins.otherArr[i])}onClickBtnBack(){Laya.stage.addChild(new CommonDlg("游戏未结束\n退出会扣除生命值哦","退出",Laya.Handler.create(Utils,Utils.back),!0))}onClickBtnCheat(){Global.isOffline&&(Global.allowForceChange?(Log.log("作弊关"),this.btnCheat.label="作弊关"):(Log.log("作弊开"),this.btnCheat.label="作弊开"),Global.allowForceChange=!Global.allowForceChange)}onClickBtnJump(){if(!Global.isOffline)return;let level=parseInt(this.txtLevel.text);level>=0&&level<=Global.maxLevel&&(this.hide(),MainGameManager.ins.startGame(level))}clearChessBoard(){for(let i=0;i<this.panelArr.length;i++)this.panelArr[i].removeSelf()}clearTarget(){this.targetBox.removeChildren()}showChangeOrderTips(callBack){callBack.run()}showTargetDlg(){this.startDlg=new NewStartView,this.startDlg.show()}hideTargetDlg(){21==GameData.ins.levelId&&Laya.timer.once(2e3,this,()=>{MainGameManager.ins.hideGuide(),ChessBoard.ins.isGuideStep=0}),this.startDlg.hide(),this.guideTips&&(this.guideTips.visible=!0,this.blackBg.alpha=.8)}addItem(item){this.panelArr[ChessBoard.ins.curRoomId].itemPanel.addChild(item)}initTarget(){let curTargetArr=GameData.ins.target.targetDataArr;if(1==curTargetArr.length){let targetView=new TargetView(curTargetArr[0].type,curTargetArr[0].num);targetView.x=60,this.targetArr.push(targetView),this.targetBox.addChild(targetView)}else for(let i=0;i<curTargetArr.length;i++){let targetView=new TargetView(curTargetArr[i].type,curTargetArr[i].num);targetView.x=i%2*100,targetView.y=120*Math.floor(i/2),this.targetArr.push(targetView),this.targetBox.addChild(targetView)}}updateTargetNum(){for(let i=0;i<GameData.ins.target.targetDataArr.length;i++)this.targetArr[i].num!=GameData.ins.target.targetDataArr[i].num&&(this.targetArr[i].num=GameData.ins.target.targetDataArr[i].num,this.targetArr[i].updateTargetNum())}switchRoom(roomId){if(GameData.ins.roomArr[roomId]){Log.log("切换房间"),ChessBoard.ins.initItemArr(roomId),this.showChessBoard();for(let i=0;i<this.panelArr.length;i++){let newX=this.panelArr[i].x-(this.panelArr[i].width+100);Laya.Tween.to(this.panelArr[i],{x:newX},2e3,null,Laya.Handler.create(this,()=>{ChessBoard.ins.isChanging=!1,this.panelArr[roomId-1].removeSelf()}))}}else Log.log("没有该房间")}stopTween(){for(let i=0;i<this.panelArr.length;i++)Laya.Tween.clearAll(this.panelArr[i])}}class LevelClearDlg extends ui.LevelClearDlgUI{constructor(data){if(super(),this.main.y=.3*(Laya.stage.height-this.main.height),GameData.ins.levelId==Global.maxLevel?(this.btn_next.skin=ResConfig.getDlgURL("btn_reward.png"),this.btn_next.on(Laya.Event.CLICK,this,this.onClickBtnBack)):this.btn_next.on(Laya.Event.CLICK,this,this.onClickBtnNext),this.btn_back.on(Laya.Event.CLICK,this,this.onClickBtnBack),data.star){let skin=ResConfig.getDlgURL("star_"+data.star+".png"),img=new Laya.Image(skin);this.starBox.addChild(img)}null!=data.prize_id&&null!=data.prize_id&&null!=data.prize_name&&null!=data.prize_name?this.txt_prizes.text=data.prize_name:(this.ewai.visible=!1,this.txt_prizes.text=""),data.assist&&(this.btn_next.visible=!1,this.ewai.visible=!1)}onClickBtnNext(){MainGameManager.ins.nextLevel(),this.removeSelf()}onClickBtnBack(){Utils.back()}show(){SoundManager.instance.playSound("gamewin"),Laya.stage.addChild(this),Laya.Tween.from(this,{alpha:0},1e3)}}class LevelFailDlg extends ui.LevelFailDlgUI{constructor(data,target){super(),this.main.y=.3*(Laya.stage.height-this.main.height),this.hpNum.text=data.hp+"",null!=data.prize_id&&null!=data.prize_id&&null!=data.prize_name&&null!=data.prize_name?this.txt_prizes.text=data.prize_name:this.txt_prizes.text="",0==data.hp?(this.btn_again.skin=ResConfig.getDlgURL("btn_add.png"),this.btn_again.on(Laya.Event.CLICK,this,this.onClickBtnAddCnt)):(this.btn_again.skin=ResConfig.getDlgURL("btn_again.png"),this.btn_again.on(Laya.Event.CLICK,this,this.onClickBtnAgain)),data.assist&&(this.btn_again.visible=!1,this.btn_help.visible=!1,this.hpNum.text=""),this.btn_back.on(Laya.Event.CLICK,this,this.onClickBtnBack),this.btn_help.on(Laya.Event.CLICK,this,this.onClickBtnHelp);let k=0;if(1==target.targetDataArr.length){let targetView=new TargetView(target.targetDataArr[0].type,target.targetDataArr[0].num,"#fff");targetView.x=77,this.targetPanel.addChild(targetView)}else for(let i=0;i<target.targetDataArr.length;i++){let targetView=new TargetView(target.targetDataArr[i].type,target.targetDataArr[i].num,"#fff");targetView.x=10+k%2*130,targetView.y=45*Math.floor(k/2),this.targetPanel.addChild(targetView),k++}}onClickBtnAgain(){MainGameManager.ins.nextLevel(),this.removeSelf()}onClickBtnAddCnt(){Global.isOffline||HttpClient.instance.request(EnumCmdName.POSTER,{},!0,Laya.Handler.create(this,this.onClickAddCntOK))}onClickAddCntOK(data){0==data.ret?(Log.log("请前往公众号查收海报",data),alert("请前往公众号查收海报")):alert(data.error)}onClickBtnBack(){Utils.back()}onClickBtnHelp(){let data={level:PlayerManager.ins.user.level};HttpClient.instance.request(EnumCmdName.HELP,data,!0,Laya.Handler.create(this,this.onClickBtnHelpOK))}onClickBtnHelpOK(data){0==data.ret?(Log.log("请前往公众号查收海报",data),alert("请前往公众号查收海报")):alert(data.error)}show(){SoundManager.instance.playSound("gamelose"),Laya.stage.addChild(this),Laya.Tween.from(this,{alpha:0},1e3)}}class MainGameManager{constructor(){this.gameState=GameState.GS_READY,this.isPlayBgm=!1,this.mainGameView=new MainGameView,EventHandler.AddListener(EventName.NEXT_ROOM,this,this.nextRoom)}static get ins(){return null==MainGameManager.instance&&(MainGameManager.instance=new MainGameManager),MainGameManager.instance}init(){if(PlayerManager.ins.getUserInfoSuc){if(0!=PlayerManager.ins.user.game_prize_status&&!PlayerManager.ins.user.code)return void Laya.stage.addChild(new CommonDlg("已全部通关啦\n记得领取奖励哦","退出",Laya.Handler.create(Utils,Utils.back)));if(PlayerManager.ins.user.code){let data={code:PlayerManager.ins.user.code};HttpClient.instance.request(EnumCmdName.ASSIST,data,!0,Laya.Handler.create(this,this.onRequestAssist))}else MainGameManager.ins.startGame(PlayerManager.ins.user.level)}else alert("读取用户信息失败，请检查网络后重试！")}onRequestAssist(data){0==data.ret?(MainGameManager.ins.startGame(data.data.level),PlayerManager.ins.user.assistLevel=data.data.level):Laya.stage.addChild(new CommonDlg(data.error,"退出",Laya.Handler.create(Utils,Utils.back)))}startLevel(data){if(GameData.ins.init(data)){let levelId=GameData.ins.levelId;GameData.ins.target;EffectManager.Instance.completed?this.startShow(levelId):Laya.timer.loop(100,this,this.startShow,[levelId])}else alert("读取关卡数据出错，请重试")}startShow(levelId){EffectManager.Instance.completed&&(this.ShowChessBoard(levelId),Laya.timer.clear(this,this.startShow))}hideTargetDlg(){this.isPlayBgm||(this.isPlayBgm=!0,SoundManager.instance.playMusic("bgm")),this.mainGameView.hideTargetDlg(),GameData.ins.levelId<Global.maxLevel&&this.preLoadLevel(GameData.ins.levelId+1)}ShowChessBoard(levelId){this.mainGameView.show(levelId)}startGame(levelId){if(levelId>Global.maxLevel)return void Laya.stage.addChild(new CommonDlg("已全部通关啦\n记得领取奖励哦","退出",Laya.Handler.create(Utils,Utils.back)));let levelJson=ResConfig.getLevelJson(levelId);Laya.loader.load(levelJson,Laya.Handler.create(this,()=>{let data=Laya.loader.getRes(levelJson);MainGameManager.ins.startLevel(data)}),null,Laya.Loader.JSON)}preLoadLevel(levelId){let levelJson=ResConfig.getLevelJson(levelId);Laya.loader.load(levelJson,null,null,Laya.Loader.JSON)}gameOver(data){0==data.ret?this.mainGameView.onGameOverOK(data):this.mainGameView.onGameOverError(data)}levelComplete(data){let commonTips;Log.log("结果",data),1==data.win?(Log.log("过关成功"),PlarLevelManager.levelUpdate("win",GameData.ins.levelId),commonTips=new LevelClearDlg(data)):(Log.log("过关失败"),PlarLevelManager.levelUpdate("lose",GameData.ins.levelId),commonTips=new LevelFailDlg(data,GameData.ins.target)),commonTips.show()}back(){Log.log("返回"),this.mainGameView.hide(),this.startGame(PlayerManager.ins.user.level)}nextLevel(){Log.log("返回"),this.mainGameView.hide(),this.startGame(PlayerManager.ins.user.level)}nextRoom(roomId){this.mainGameView.switchRoom(roomId)}hideGuide(){this.mainGameView.hideGuide()}}class ChessBoard{static get ins(){return null==ChessBoard.instance&&(ChessBoard.instance=new ChessBoard),ChessBoard.instance}get step(){return this._step}constructor(){}init(){this.selectId=null,this.lastSelectId=null,this.row=GameData.ins.row,this.col=GameData.ins.col,this.curRoomId=0,this.donutNum=0,this.emptyArr=[],this.lastMoveArr=[],this.removeItemArr=[],this.needToGrassArr=[],this.singlePropsArr=[],this.normalClearArr=[],this.usePropsClearArr=[],this.propsArr=[],this.isChanging=!1,this.isFalling=!1,this.itemArr=[],this.backArr=[],this.otherArr=[],this.gameOver=!1,this.isMouseDown=!1,this.waitClearNum=0,this.waitWithOutArr=[],this.isGuideStep=1,this.isPause=!1,Laya.timer.clearAll(this),this._step=GameData.ins.step,this.updateStep(this._step)}initItemArr(roomId){this.curRoomId=roomId;let id=0,room=GameData.ins.roomArr[roomId];for(let k=0;k<this.row;k++)for(let j=0;j<this.col;j++){let backType=room.backArr[id].type;this.backArr[id]=new Back(id,j,k,backType);let isTop=room.otherArr[id].isTop,isBottom=room.otherArr[id].isBottom,portalNum=room.otherArr[id].portalNum,guardArr=room.otherArr[id].guardArr;if(this.otherArr[id]=new Other(id,j,k,isTop,isBottom,portalNum,guardArr),this.otherArr[id].addPortal(),this.otherArr[id].addGuard(),null==room.itemArr[id].color){this.itemArr[id]=null,id++;continue}let color=room.itemArr[id].color,type=ItemType.NORMAL,hp=room.itemArr[id].hp;null!=room.itemArr[id].type&&(type=room.itemArr[id].type),this.itemArr[id]=new Item(id,j,k,type,hp,color),id++}id=0;for(let k=0;k<this.row;k++)for(let j=0;j<this.col;j++){if(null==this.itemArr[id]){let type=ItemType.NORMAL,hp=room.itemArr[id].hp;null!=room.itemArr[id].type&&(type=room.itemArr[id].type);let color=this.getColor(id);room.itemArr[id].color=color,this.itemArr[id]=new Item(id,j,k,type,hp,color),type==ItemType.DONUT&&this.donutNum++}this.borderHandle(id),id++}this.checkChange(!1),Log.log("ItemArr:",this.itemArr),GameData.ins.initBoardData()}checkExchangeItem(id,useProps=!1){if(!this.gameOver&&!this.isChanging)if(this.clearTipsItem(),useProps){HttpClient.instance.request(EnumCmdName.MOVE,PlayerManager.ins.user.token,!1,null,null,null,!0),this.isChanging=!0,this.selectId=null;let callback=Laya.Handler.create(this,()=>{this.emptyArr.length>0&&(this.updateStep(),this.waitClearNum++,this.startClear())});this.useProps(id,null,callback)}else this.selectId==id-1&&0==this.otherArr[id].guardArr[3]||this.selectId==id+1&&0==this.otherArr[id].guardArr[1]||this.selectId==id+this.col&&0==this.otherArr[id].guardArr[2]||this.selectId==id-this.col&&0==this.otherArr[id].guardArr[0]?(this.isChanging=!0,Log.log("将"+this.selectId+"和"+id+"交换"),this.ChangeBoxAni(this.selectId,id)):(Log.log("不支持移动"),this.selectId&&this.itemArr[this.selectId].setSelect(!1),this.itemArr[id].setSelect(!0),this.selectId=id)}ChangeBoxAni(id1,id2,check=!0){this.emptyArr=[],this.itemArr[id1].setSelect(!1),this.selectId=null;let temp=this.itemArr[id1];this.itemArr[id1]=this.itemArr[id2],this.itemArr[id2]=temp,this.itemArr[id1].moveToIdPos(id1),this.itemArr[id2].moveToIdPos(id2,Global.TWEENTIME,Laya.Handler.create(this,()=>{if(check){let callback=Laya.Handler.create(this,()=>{if(this.emptyArr.length>0)HttpClient.instance.request(EnumCmdName.MOVE,PlayerManager.ins.user.token,!1,null,null,null,!0),this.updateStep(),this.waitClearNum++,this.startClear();else{if(Global.allowForceChange)return void(this.isChanging=!1);Log.log("无法清除"),this.ChangeBoxAni(id1,id2,!1),Laya.timer.once(Global.TWEENTIME,this,()=>{this.isChanging=!1})}}),ballCallback=Laya.Handler.create(this,back=>{if(back){if(Global.allowForceChange)return void(this.isChanging=!1);Log.log("无法清除"),this.ChangeBoxAni(id1,id2,!1),Laya.timer.once(Global.TWEENTIME,this,()=>{this.isChanging=!1})}else HttpClient.instance.request(EnumCmdName.MOVE,PlayerManager.ins.user.token,!1,null,null,null,!0),this.updateStep()});this.itemArr[id1].type==ItemType.BALL&&this.itemArr[id2].type!=ItemType.BALL||this.itemArr[id2].type==ItemType.BALL&&this.itemArr[id1].type!=ItemType.BALL?this.itemArr[id1].type>100&&this.itemArr[id2].type>100?this.useProps(id2,id1,ballCallback):this.itemArr[id1].type==ItemType.BALL?(this.checkClear([id2]),this.emptyArr=[],this.useProps(id1,id2,ballCallback)):this.itemArr[id2].type==ItemType.BALL&&(this.checkClear([id1]),this.emptyArr=[],this.useProps(id2,id1,ballCallback)):this.itemArr[id1].type>100&&this.itemArr[id2].type>100?this.useProps(id2,id1,callback):this.itemArr[id1].type>100?(this.checkClear([id2]),this.useProps(id1,id2,callback)):this.itemArr[id2].type>100?(this.checkClear([id1]),this.useProps(id2,id1,callback)):(this.checkClear([id1,id2]),callback.run())}}))}useProps(id,exchangeId,callback){if(exchangeId&&this.itemArr[id].type==ItemType.BALL&&this.itemArr[exchangeId].type<100&&(this.itemArr[exchangeId].color<0||null==this.itemArr[exchangeId].color))return void(callback&&callback.runWith(!0));let tempArr=[];exchangeId&&this.backArr[exchangeId].type==BackType.GRASS&&this.backArr[id].changeType(BackType.GRASS),exchangeId&&this.itemArr[exchangeId].type>100&&this.getCompoundProps(id,exchangeId),tempArr=this.itemArr[id].useProps(exchangeId),this.checkComboProps(tempArr),this.usePropsClearArr.push.apply(this.usePropsClearArr,tempArr),this.emptyArr.push.apply(this.emptyArr,tempArr),this.emptyArr=Utils.unique(this.emptyArr),callback&&callback.run()}startClear(){this.gameOver||(Log.log("需要清除的Item:",this.emptyArr),this.checkNextClear(this.normalClearArr),this.checkNextClear(this.usePropsClearArr,!0),this.checkGuardClear(this.usePropsClearArr),this.normalClearArr=[],this.usePropsClearArr=[],this.changeBackType(this.needToGrassArr,BackType.GRASS),this.needToGrassArr=[],this.clearItem())}clearItem(){for(let i=0;i<this.emptyArr.length;i++)this.itemArr[this.emptyArr[i]].clearSelf();SoundManager.instance.playSound("eliminate"),SoundManager.instance.playItemSound(),this.emptyArr=[],Laya.timer.once(Global.CLEARTWEENTIME,this,()=>{if(this.propsArr.length>0){let length=this.propsArr.length;Log.log("还存在需要使用的加速道具:",this.propsArr);for(let i=0;i<length;i++){let id=this.propsArr.shift();this.useProps(id)}this.startClear()}else this.singlePropsArr.length>0&&(SoundManager.instance.playSound("initProp"),this.createSingleProps(),this.singlePropsArr=[]),this.isNeedFill()})}isNeedFill(){if(this.isFalling)return void this.waitClearNum--;if(this.isPause)return void this.waitClearNum--;this.isFalling=!0,this.updateTarget(),this.removeItemArr=[];let isMove=!1;for(let i=this.itemArr.length-1;i>=0;i--)this.moveDown(i)&&(isMove=!0);if(SoundManager.instance.playSound("fall"),isMove)Laya.timer.once(Global.MOVEDOWNTIME,this,()=>{this.isFalling=!1,this.isNeedFill()});else{this.emptyArr=[];for(let i=this.itemArr.length-1;i>=0;i--)this.checkDonut(i);if(this.lastMoveArr=Utils.unique(this.lastMoveArr),this.checkClear(this.lastMoveArr,!1),this.lastMoveArr=[],this.emptyArr.length>0)this.isFalling=!1,this.startClear();else{this.waitClearNum--,Log.log("清除和下落全部完成,",this.itemArr);for(let i=this.itemArr.length-1;i>=0;i--)null==this.itemArr[i].color&&null==this.itemArr[i].parent&&this.createNewSpace(i);this.isFalling=!1,0==this.waitClearNum&&(this.isChanging=!1,this.isGameOver(),this.gameOver||this.checkChange(),GameData.ins.initBoardData())}}}checkClear(arr,isFirst=!0){let tempArr=[],noCheckArr=[];for(let i=0;i<arr.length;i++){let id=arr[i];if(this.itemArr[id].clearType!=ClearType.SELF||null==this.itemArr[id].color||this.itemArr[id].type>100){arr.splice(i,1),i--;continue}if(this.itemArr[id].type==ItemType.DONUT)continue;let rowArr=this.findNextSameColor(id,this.itemArr[id].color),colArr=this.findNextSameColor(id,this.itemArr[id].color,!1);if(rowArr.length>=5||colArr.length>=5){if(rowArr.length>=5){Log.log("ID："+id+"生成彩虹球",rowArr);for(let k=0;k<rowArr.length;k++){noCheckArr.push(rowArr[k]);let index=arr.indexOf(rowArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,rowArr)}if(colArr.length>=5){Log.log("ID："+id+"生成彩虹球",colArr);for(let k=0;k<colArr.length;k++){noCheckArr.push(colArr[k]);let index=arr.indexOf(colArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,colArr)}this.addSinglePropsToArr(id,ItemType.BALL),i--}}for(let i=0;i<arr.length;i++){let id=arr[i],rowArr=this.findNextSameColor(id,this.itemArr[id].color,!0,noCheckArr),colArr=this.findNextSameColor(id,this.itemArr[id].color,!1,noCheckArr);if(rowArr.length>=3&&colArr.length>=3){let clearArr=[];clearArr.push.apply(clearArr,colArr),clearArr.push.apply(clearArr,rowArr),Log.log("ID："+id+"生成炸弹",clearArr);for(let k=0;k<clearArr.length;k++){noCheckArr.push(clearArr[k]);let index=arr.indexOf(clearArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,clearArr),this.addSinglePropsToArr(id,ItemType.BOMB),i--}}for(let i=0;i<arr.length;i++){let id=arr[i],rowArr=this.findNextSameColor(id,this.itemArr[id].color,!0,noCheckArr),colArr=this.findNextSameColor(id,this.itemArr[id].color,!1,noCheckArr);if(4==colArr.length){Log.log("ID："+id+"生成横向火箭",colArr);for(let k=0;k<colArr.length;k++){noCheckArr.push(colArr[k]);let index=arr.indexOf(colArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,colArr),this.addSinglePropsToArr(id,ItemType.HENG),i--}else if(4==rowArr.length){Log.log("ID："+id+"生成竖向火箭",rowArr);for(let k=0;k<rowArr.length;k++){noCheckArr.push(rowArr[k]);let index=arr.indexOf(rowArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,rowArr),this.addSinglePropsToArr(id,ItemType.SHU),i--}}for(let i=0;i<arr.length;i++){let id=arr[i],planeArr=[],rowArr=this.findNextSameColor(id,this.itemArr[id].color,!0,noCheckArr),colArr=this.findNextSameColor(id,this.itemArr[id].color,!1,noCheckArr);if(rowArr.length>=3&&tempArr.push.apply(tempArr,rowArr),colArr.length>=3&&tempArr.push.apply(tempArr,colArr),this.isPlane(id,this.itemArr[id].color,noCheckArr,planeArr)){Log.log("ID："+id+"生成飞机",planeArr);for(let k=0;k<planeArr.length;k++){noCheckArr.push(planeArr[k]);let index=arr.indexOf(rowArr[k]);index>=i&&arr.splice(index,1)}tempArr.push.apply(tempArr,planeArr),this.addSinglePropsToArr(id,ItemType.PLANE),i--}}for(let i=0;i<arr.length;i++){let id=arr[i];this.itemArr[id].type==ItemType.DONUT&&(!isFirst||tempArr.length>0||Global.allowForceChange)&&tempArr.push(id)}tempArr.length>0&&(this.emptyArr.push.apply(this.emptyArr,tempArr),this.emptyArr=Utils.unique(this.emptyArr),this.normalClearArr.push.apply(this.normalClearArr,this.emptyArr),this.checkGrassExtend(this.emptyArr))}checkNextClear(arr,useProps=!1){let tempArr=[];for(let i=0;i<arr.length;i++){let id=arr[i],posX=id%this.col,posY=Math.floor(id/this.col);(this.itemArr[id].type==ItemType.NORMAL||this.itemArr[id].type==ItemType.SPACE||this.itemArr[id].type>100)&&(posX>0&&arr.indexOf(id-1)<0&&(this.itemArr[id-1].clearType==ClearType.NEXT||!useProps&&this.itemArr[id-1].clearType==ClearType.NEXT_NOT_PROPS)&&tempArr.push(id-1),posX<this.col-1&&arr.indexOf(id+1)<0&&(this.itemArr[id+1].clearType==ClearType.NEXT||!useProps&&this.itemArr[id+1].clearType==ClearType.NEXT_NOT_PROPS)&&tempArr.push(id+1),posY>0&&arr.indexOf(id-this.col)<0&&(this.itemArr[id-this.col].clearType==ClearType.NEXT||!useProps&&this.itemArr[id-this.col].clearType==ClearType.NEXT_NOT_PROPS)&&tempArr.push(id-this.col),posY<this.row-1&&arr.indexOf(id+this.col)<0&&(this.itemArr[id+this.col].clearType==ClearType.NEXT||!useProps&&this.itemArr[id+this.col].clearType==ClearType.NEXT_NOT_PROPS)&&tempArr.push(id+this.col))}tempArr.length>0&&(Log.log("清除类型NEXT的需要清除的数组:",tempArr),this.emptyArr.push.apply(this.emptyArr,tempArr),this.emptyArr=Utils.unique(this.emptyArr))}checkGuardClear(arr){for(let i=0;i<arr.length;i++)if(this.otherArr[arr[i]].guardArr.indexOf(1)>=0)for(let k=0;k<4;k++)if(1==this.otherArr[arr[i]].guardArr[k])switch(k){case 0:let topIndex=arr.indexOf(arr[i]-this.col);topIndex>=0&&(this.otherArr[arr[i]].removeGuard(k),this.otherArr[topIndex].removeGuard(k));break;case 1:let rightIndex=arr.indexOf(arr[i]+1);rightIndex>=0&&(this.otherArr[arr[i]].removeGuard(k),this.otherArr[rightIndex].removeGuard(k));break;case 2:let bottomIndex=arr.indexOf(arr[i]+this.col);bottomIndex>=0&&(this.otherArr[arr[i]].removeGuard(k),this.otherArr[bottomIndex].removeGuard(k));break;case 3:let leftIndex=arr.indexOf(arr[i]-1);leftIndex>=0&&(this.otherArr[arr[i]].removeGuard(k),this.otherArr[leftIndex].removeGuard(k))}}checkGrassExtend(arr){for(let i=0;i<arr.length;i++)this.backArr[arr[i]].type==BackType.GRASS&&this.findGrassDFS(arr[i],-1,arr)}canBeGrass(id){if(this.backArr[id].type!=BackType.NORMAL)return!1;if(this.itemArr[id].type>100)return!0;switch(this.itemArr[id].type){case ItemType.LOCKED:case ItemType.SPACE:case ItemType.NORMAL:case ItemType.DONUT:return!0}return!1}changeBackType(arr,type){switch(type){case BackType.GRASS:for(let i=0;i<arr.length;i++)ChessBoard.ins.canBeGrass(arr[i])&&ChessBoard.ins.backArr[arr[i]].changeType(BackType.GRASS)}}createSingleProps(){for(let i=0;i<this.singlePropsArr.length;i++){let id=this.singlePropsArr[i].id,type=this.singlePropsArr[i].type,item=new Item(id,this.itemArr[id].posX,this.itemArr[id].posY,type,2,null);this.itemArr[id]=item,EventHandler.Dispatch(EventName.ADD_ITEM,[item])}}checkChange(confirm=!0){this.checkAllItem()||this.changeOrder(confirm)}checkAllItem(){let arr=this.itemArr;for(let k=0;k<this.row;k++)for(let j=0;j<this.col;j++){let i=k*this.col+j;if(arr[i].type>100){if(104==arr[i].type){if(j>0&&arr[i-1].exchangeable&&(arr[i-1].color>0||arr[i-1].type>100))return this.setTips(i,Direction.LEFT),!0;if(j<this.col-1&&arr[i+1].exchangeable&&(arr[i+1].color>0||arr[i+1].type>100))return this.setTips(i,Direction.RIGHT),!0;if(k>0&&arr[i-this.col].exchangeable&&(arr[i-this.col].color>0||arr[i-this.col].type>100))return this.setTips(i,Direction.UP),!0;if(k<this.col-1&&arr[i+this.col].exchangeable&&(arr[i+this.col].color>0||arr[i+this.col].type>100))return this.setTips(i,Direction.DOWN),!0;continue}return Log.log("存在加速道具",i),!0}if(null!=arr[i].color&&-1!=arr[i].color){if(j+1<this.col&&arr[i].color==arr[i+1].color){if(arr[i].clearType!=ClearType.SELF||arr[i+1].clearType!=ClearType.SELF)continue;if(j-1>=0&&arr[i-1].exchangeable){if(j-2>=0&&arr[i-2].color==arr[i].color&&arr[i-2].exchangeable)return Log.log("横向方式一可消除，左",i),this.setTips(i-2,Direction.RIGHT),!0;if(k-1>=0&&arr[i-this.col-1].color==arr[i].color&&arr[i-this.col-1].exchangeable)return Log.log("横向方式一可消除，左上",i),this.setTips(i-this.col-1,Direction.DOWN),!0;if(k+1<this.row&&arr[i+this.col-1].color==arr[i].color&&arr[i+this.col-1].exchangeable)return Log.log("横向方式一可消除，左下",i),this.setTips(i+this.col-1,Direction.UP),!0}if(j+2<this.col&&arr[i+2].exchangeable){if(j+3<this.col&&arr[i+3].color==arr[i].color&&arr[i+3].exchangeable)return Log.log("横向方式一可消除，右",i),this.setTips(i+3,Direction.LEFT),!0;if(k-1>=0&&arr[i-this.col+2].color==arr[i].color&&arr[i-this.col+2].exchangeable)return Log.log("横向方式一可消除，右上",i),this.setTips(i-this.col+2,Direction.DOWN),!0;if(k+1<this.row&&arr[i+this.col+2].color==arr[i].color&&arr[i+this.col+2].exchangeable)return Log.log("横向方式一可消除，右下",i),this.setTips(i+this.col+2,Direction.UP),!0}}if(k+1<this.row&&arr[i].color==arr[i+this.col].color){if(arr[i].clearType!=ClearType.SELF||arr[i+this.col].clearType!=ClearType.SELF)continue;if(arr[i-this.col]&&arr[i-this.col].exchangeable){if(k-2>=0&&arr[i-2*this.col].color==arr[i].color&&arr[i-2*this.col].exchangeable)return Log.log("竖向方式一可消除，上",i),this.setTips(i-2*this.col,Direction.DOWN),!0;if(j-1>=0&&k-1>=0&&arr[i-this.col-1].color==arr[i].color&&arr[i-this.col-1].exchangeable)return Log.log("竖向方式一可消除，左上",i),this.setTips(i-this.col-1,Direction.RIGHT),!0;if(j+1<this.col&&k-1>=0&&arr[i-this.col+1].color==arr[i].color&&arr[i-this.col+1].exchangeable)return Log.log("竖向方式一可消除，右上",i),this.setTips(i-this.col+1,Direction.LEFT),!0}if(arr[i+2*this.col]&&arr[i+2*this.col].exchangeable){if(k+3<this.row&&arr[i+3*this.col].color==arr[i].color&&arr[i+3*this.col].exchangeable)return Log.log("竖向方式一可消除，下",i),this.setTips(i+3*this.col,Direction.UP),!0;if(j-1>=0&&k+2<this.row&&arr[i+2*this.col-1].color==arr[i].color&&arr[i+2*this.col-1].exchangeable)return Log.log("竖向方式一可消除，左下",i),this.setTips(i+2*this.col-1,Direction.RIGHT),!0;if(j+1<this.col&&k+2<this.row&&arr[i+2*this.col+1].color==arr[i].color&&arr[i+2*this.col+1].exchangeable)return Log.log("竖向方式一可消除，右下",i),this.setTips(i+2*this.col+1,Direction.LEFT),!0}}if(j+2<this.col&&arr[i].color==arr[i+2].color&&arr[i+1]&&arr[i+1].exchangeable){if(arr[i].clearType!=ClearType.SELF||arr[i+2].clearType!=ClearType.SELF)continue;if(k-1>=0&&arr[i-this.col+1].color==arr[i].color&&arr[i-this.col+1].exchangeable)return Log.log("横向方式二可消除，上",i),this.setTips(i-this.col+1,Direction.DOWN),!0;if(k+1<this.row&&arr[i+this.col+1].color==arr[i].color&&arr[i+this.col+1].exchangeable)return Log.log("横向方式二可消除，下",i),this.setTips(i+this.col+1,Direction.UP),!0}if(k+2<this.row&&arr[i+2*this.col].color==arr[i].color&&arr[i+this.col]&&arr[i+this.col].exchangeable){if(arr[i].clearType!=ClearType.SELF||arr[i+2*this.col].clearType!=ClearType.SELF)continue;if(j-1>=0&&arr[i+this.col-1].color==arr[i].color&&arr[i+this.col-1].exchangeable)return Log.log("竖向方式二可消除，左",i),this.setTips(i+this.col-1,Direction.RIGHT),!0;if(j+1<this.col&&arr[i+this.col+1].color==arr[i].color&&arr[i+this.col+1].exchangeable)return Log.log("竖向方式二可消除，右",i),this.setTips(i+this.col+1,Direction.LEFT),!0}}}return Log.log("无可清除项"),!1}changeOrder(confirm){Log.log("乱序");let callback=Laya.Handler.create(this,()=>{for(let i=0;i<this.itemArr.length;i++){let item=this.itemArr[i];if(item.type==ItemType.NORMAL){let color=this.getColor(i);item.changeColor(color)}}this.checkChange(!1),GameData.ins.initBoardData()});confirm?EventHandler.Dispatch(EventName.CHANGE_ORDER,[callback]):callback.run()}setTips(id,direction){this.clearTipsItem(),this.itemArr[id].setTips(direction)}clearTipsItem(){for(let i=0;i<this.itemArr.length;i++)this.itemArr[i].isTipsItem&&this.itemArr[i].clearTipsItem()}addItem(id,direction,num,arr,penetrable=!1,grass=!1){let needChangeToGrass=!1;switch(direction){case Direction.UP:for(let i=1;i<=num&&!(id-i*this.col>=0&&(grass&&this.backArr[id-i*this.col].type==BackType.GRASS&&(needChangeToGrass=!0),grass&&needChangeToGrass&&this.canBeGrass(id-i*this.col)&&this.addToGrassArr([id-i*this.col]),arr.push(id-i*this.col),penetrable&&0==this.itemArr[id-i*this.col].penetrable));i++);break;case Direction.DOWN:for(let i=1;i<=num&&!(id+i*this.col<this.col*this.row&&(grass&&this.backArr[id+i*this.col].type==BackType.GRASS&&(needChangeToGrass=!0),grass&&needChangeToGrass&&this.canBeGrass(id+i*this.col)&&this.addToGrassArr([id+i*this.col]),arr.push(id+i*this.col),penetrable&&0==this.itemArr[id+i*this.col].penetrable));i++);break;case Direction.LEFT:for(let i=1;i<=num&&!(id-i>=0&&id%this.col>=i&&(grass&&this.backArr[id-i].type==BackType.GRASS&&(needChangeToGrass=!0),grass&&needChangeToGrass&&this.canBeGrass(id-i)&&this.addToGrassArr([id-i]),arr.push(id-i),penetrable&&0==this.itemArr[id-i].penetrable));i++);break;case Direction.RIGHT:for(let i=1;i<=num&&!(id+i<this.col*this.row&&id%this.col<this.col-i&&(grass&&this.backArr[id+i].type==BackType.GRASS&&(needChangeToGrass=!0),grass&&needChangeToGrass&&this.canBeGrass(id+i)&&this.addToGrassArr([id+i]),arr.push(id+i),penetrable&&0==this.itemArr[id+i].penetrable));i++);}}checkComboProps(arr){for(let i=0;i<arr.length;i++)this.itemArr[arr[i]].type>100&&2==this.itemArr[arr[i]].hp&&-1==this.propsArr.indexOf(arr[i])&&this.propsArr.push(arr[i])}moveDown(id){let isMove=!1;if(null==this.itemArr[id].color&&1==this.itemArr[id].movable){let tempId=id,length=1,isPortal=!1;this.otherArr[tempId].portalNum<0&&(tempId=this.findOtherPortal(tempId)+length*this.col,isPortal=!0);let k=tempId%this.col,num=tempId-length*this.col;if(0==this.otherArr[id].isTop)for(;;){if(num>=0)if(0==this.itemArr[num].movable||1==this.otherArr[num].guardArr[2]){let floor=0;for(let i=0;i<length;i++){if(k>0){let leftItem=num-1+floor*this.col;if(this.otherArr[leftItem+1].portalNum>0){k=(num=this.findOtherPortal(leftItem+1))%this.col,floor=0;continue}if(1==this.itemArr[leftItem].movable&&(0==this.otherArr[leftItem+1].guardArr[2]||0==this.otherArr[leftItem].guardArr[2])){if(null!=this.itemArr[leftItem].color){if(leftItem!=id-this.col-1||null==this.itemArr[id-1].color||isPortal)break;this.itemArr[id].recover(),this.itemArr[id]=this.itemArr[leftItem],this.createNewSpace(leftItem),this.itemArr[id].moveToIdPos(id,Global.MOVEDOWNTIME),isMove=!0,this.lastMoveArr.push(id);break}}}if(k<this.col-1){let rightItem=num+1+floor*this.col;if(this.otherArr[rightItem-1].portalNum>0){k=(num=this.findOtherPortal(rightItem-1))%this.col,floor=0;continue}if(1==this.itemArr[rightItem].movable&&(0==this.otherArr[rightItem-1].guardArr[2]||0==this.otherArr[rightItem].guardArr[2])){if(null!=this.itemArr[rightItem].color){if(rightItem!=id-this.col+1||null==this.itemArr[id+1].color||isPortal)break;this.itemArr[id].recover(),this.itemArr[id]=this.itemArr[rightItem],this.createNewSpace(rightItem),this.itemArr[id].moveToIdPos(id,Global.MOVEDOWNTIME),isMove=!0,this.lastMoveArr.push(id);break}}}floor++}}else{if(null==this.itemArr[num].color){if(this.otherArr[num].isTop)break;length++,this.otherArr[num].portalNum<0&&(tempId=this.findOtherPortal(num)+length*this.col),k=(num=tempId-length*this.col)%this.col;continue}if(1==length){this.itemArr[id].recover(),this.itemArr[id]=this.itemArr[num],this.createNewSpace(num),isMove=!0,this.lastMoveArr.push(id),1==isPortal?this.itemArr[id].throughPortal(id,Global.MOVEDOWNTIME):this.itemArr[id].moveToIdPos(id,Global.MOVEDOWNTIME);break}}break}else{let item,tempY=this.itemArr[id].posY-1;switch(this.isNeedCreateItem(id)){case ItemType.DONUT:item=new Item(id,this.itemArr[id].posX,tempY,ItemType.DONUT,1,null);break;default:let Newcolor=this.getRandomColor();item=new Item(num,this.itemArr[id].posX,tempY,ItemType.NORMAL,1,Newcolor)}this.itemArr[id].recover(),this.itemArr[id]=item,this.itemArr[id].moveToIdPos(id,Global.MOVEDOWNTIME),EventHandler.Dispatch(EventName.ADD_ITEM,[item]),isMove=!0,this.lastMoveArr.push(id)}}return isMove}isNeedCreateItem(id){let roomTarget=GameData.ins.roomArr[this.curRoomId].roomTarget,donutData=GameData.ins.donutData;for(let i=0;i<GameData.ins.target.targetDataArr.length;i++)if(roomTarget.targetDataArr[i].type==Target.DONUT&&this.donutNum<roomTarget.targetDataArr[i].num&&this.donutNum<donutData.maxNum)if(donutData.count<=0){let posX=this.itemArr[id].posX;if(donutData.colArr.indexOf(posX)>=0)return Log.log("需要生成甜甜圈"),this.donutNum++,donutData.count=donutData.waitingTime,ItemType.DONUT}else donutData.count--;return null}isPlane(id,color,noCheckArr=[],arr){let posX=id%this.col,posY=Math.floor(id/this.col);return noCheckArr.indexOf(id+1)<0&&noCheckArr.indexOf(id+this.col)<0&&noCheckArr.indexOf(id+this.col+1)<0&&posX<this.col-1&&posY<this.row-1&&this.checkForColor(id+1,color)&&this.checkForColor(id+this.col,color)&&this.checkForColor(id+this.col+1,color)?(arr&&arr.push(id,id+1,id+this.col,id+this.col+1),!0):noCheckArr.indexOf(id-1)<0&&noCheckArr.indexOf(id+this.col)<0&&noCheckArr.indexOf(id+this.col-1)<0&&posX>0&&posY<this.row-1&&this.checkForColor(id-1,color)&&this.checkForColor(id+this.col,color)&&this.checkForColor(id+this.col-1,color)?(arr&&arr.push(id,id-1,id+this.col,id+this.col-1),!0):noCheckArr.indexOf(id+1)<0&&noCheckArr.indexOf(id-this.col)<0&&noCheckArr.indexOf(id-this.col+1)<0&&posX<this.col-1&&posY>0&&this.checkForColor(id+1,color)&&this.checkForColor(id-this.col,color)&&this.checkForColor(id-this.col+1,color)?(arr&&arr.push(id,id+1,id-this.col,id-this.col+1),!0):!!(noCheckArr.indexOf(id-1)<0&&noCheckArr.indexOf(id-this.col)<0&&noCheckArr.indexOf(id-this.col-1)<0&&posX>0&&posY>0&&this.checkForColor(id-1,color)&&this.checkForColor(id-this.col,color)&&this.checkForColor(id-this.col-1,color))&&(arr&&arr.push(id,id-1,id-this.col,id-this.col-1),!0)}getCompoundProps(id,exchangeId){let type1=this.itemArr[id].type,type2=this.itemArr[exchangeId].type;if(type1>type2){let temp=type1;type1=type2,type2=temp}let compoundPropStr=type1+""+type2;Log.log("获取到的复合加速道具为：",compoundPropStr),this.itemArr[exchangeId].hp=1,this.itemArr[exchangeId].visible=!1;let type=Props.CompoundPropsObj[compoundPropStr];this.itemArr[id].changeType(type)}findGrassDFS(id,direction,arr){direction!=Direction.UP&&id-this.col>=0&&arr.indexOf(id-this.col)>-1&&this.canBeGrass(id-this.col)&&this.needToGrassArr.indexOf(id-this.col)<0&&(this.addToGrassArr([id-this.col]),this.findGrassDFS(id-this.col,Direction.DOWN,arr)),direction!=Direction.DOWN&&id+this.col<this.row*this.col&&arr.indexOf(id+this.col)>-1&&this.canBeGrass(id+this.col)&&this.needToGrassArr.indexOf(id+this.col)<0&&(this.addToGrassArr([id+this.col]),this.findGrassDFS(id+this.col,Direction.UP,arr)),direction!=Direction.LEFT&&id%this.col>0&&arr.indexOf(id-1)>-1&&this.canBeGrass(id-1)&&this.needToGrassArr.indexOf(id-1)<0&&(this.addToGrassArr([id-1]),this.findGrassDFS(id-1,Direction.RIGHT,arr)),direction!=Direction.RIGHT&&id%this.col<this.col-1&&arr.indexOf(id+1)>-1&&this.canBeGrass(id+1)&&this.needToGrassArr.indexOf(id+1)<0&&(this.addToGrassArr([id+1]),this.findGrassDFS(id+1,Direction.LEFT,arr))}findNextSameColor(id,color,isHeng=!0,noCheckArr=[]){if(-1==color)return[];if(isHeng){let tempId=id,rowArr=[tempId],maxRowId=this.col*(Math.floor(id/this.col)+1)-1;for(;tempId<maxRowId&&this.checkForColor(tempId+1,color)&&noCheckArr.indexOf(tempId+1)<0;)tempId++,rowArr.push(tempId);tempId=id;let minRowId=this.col*Math.floor(id/this.col);for(;tempId>minRowId&&this.checkForColor(tempId-1,color)&&noCheckArr.indexOf(tempId-1)<0;)tempId--,rowArr.push(tempId);return rowArr}{let tempId=id,colArr=[tempId],maxColId=(this.row-1)*this.col+id%this.col;for(;tempId<maxColId&&this.checkForColor(tempId+this.col,color)&&noCheckArr.indexOf(tempId+this.col)<0;)tempId+=this.col,colArr.push(tempId);tempId=id;let minColId=id%this.col;for(;tempId>minColId&&this.checkForColor(tempId-this.col,color)&&noCheckArr.indexOf(tempId-this.col)<0;)tempId-=this.col,colArr.push(tempId);return colArr}}findSameColor(color){let arr=[];for(let i=0;i<this.itemArr.length;i++)this.checkForColor(i,color)&&arr.push(i);return Log.log("颜色都为"+color+"的Item有"+arr),arr}findOneOfTargetItem(id,withOutArr){let newWithOutArr=[];newWithOutArr.push(...withOutArr),newWithOutArr.push(...this.waitWithOutArr);let targetArr=GameData.ins.target.targetDataArr,tempArr=[];for(let i=0;i<targetArr.length;i++)0!=targetArr[i].num&&tempArr.push(i);if(0==tempArr.length){let ran;do{ran=Math.floor(Math.random()*this.itemArr.length)}while(this.itemArr[ran].clearType==ClearType.UNABLE||newWithOutArr.indexOf(ran)>=0);return Log.log("没有目标剩余",ran),ran}let index,targetType,random=-1,resultArr=[];for(;0==resultArr.length;){if(random>-1&&(tempArr.splice(random,1),Log.log("这个目标场上数量为空，或是无法消除此目标",targetType)),0==tempArr.length){let ran;do{ran=Math.floor(Math.random()*this.itemArr.length)}while(this.itemArr[ran].clearType==ClearType.UNABLE);return Log.log("场上没有目标可清除",ran),ran}switch(targetType=targetArr[index=tempArr[random=Math.floor(Math.random()*tempArr.length)]].type){case Target.GRASS:if(this.backArr[id].type==BackType.GRASS)for(let i=0;i<this.backArr.length;i++)this.backArr[i].type==BackType.NORMAL&&newWithOutArr.indexOf(i)<0&&resultArr.push(i);break;case Target.RED:case Target.YELLOW:case Target.GREEN:case Target.PINK:case Target.BLUE:for(let i=0;i<this.itemArr.length;i++)this.itemArr[i].color==targetType&&newWithOutArr.indexOf(i)<0&&this.itemArr[i].hp>0&&resultArr.push(i);break;case Target.DONUT:for(let i=0;i<this.itemArr.length;i++){let doNutTempArr=[];if(this.itemArr[i].type==ItemType.DONUT){let k=1,tempId=i,selType=-1;for(;tempId+k*this.col<this.col*this.row;){if(this.itemArr[tempId+k*this.col].clearType!=ClearType.UNABLE&&newWithOutArr.indexOf(tempId+k*this.col)<0&&this.itemArr[tempId+k*this.col].hp>0&&this.itemArr[tempId+k*this.col].type!=ItemType.SPACE&&-1==resultArr.indexOf(tempId+k*this.col)){let type=this.itemArr[tempId+k*this.col].type;-1==selType?type==ItemType.BOX||type==ItemType.CHERRY||type==ItemType.LOCKED||type==ItemType.BISCUIT||type==ItemType.SUGER?(doNutTempArr=[tempId+k*this.col],selType=type):doNutTempArr.push(tempId+k*this.col):type==selType&&doNutTempArr.push(tempId+k*this.col)}if(this.otherArr[tempId+k*this.col].portalNum>0)tempId=this.findOtherPortal(tempId+k*this.col),k=0;else{if(1==this.otherArr[tempId+k*this.col].isBottom||this.itemArr[tempId+k*this.col].type==ItemType.DEAD)break;k++}}}doNutTempArr.length>0&&(resultArr.push(...doNutTempArr),resultArr=Utils.unique(resultArr))}Log.log("甜甜圈Arr",resultArr);break;case Target.CHERRY:for(let i=0;i<this.itemArr.length;i++)this.itemArr[i].type==ItemType.CHERRY&&newWithOutArr.indexOf(i)<0&&this.itemArr[i].hp>0&&resultArr.push(i);break;case Target.BISCUIT:for(let i=0;i<this.itemArr.length;i++)this.itemArr[i].type==ItemType.BISCUIT&&newWithOutArr.indexOf(i)<0&&this.itemArr[i].hp>0&&resultArr.push(i);break;case Target.BOX:for(let i=0;i<this.itemArr.length;i++)this.itemArr[i].type==ItemType.BOX&&newWithOutArr.indexOf(i)<0&&this.itemArr[i].hp>0&&resultArr.push(i)}}return resultArr[Math.floor(Math.random()*resultArr.length)]}checkForColor(id,color){return null!=this.itemArr[id]&&this.itemArr[id].color==color&&this.itemArr[id].clearType==ClearType.SELF}checkDonut(id){this.otherArr[id].isBottom&&this.itemArr[id].type==ItemType.DONUT&&(this.itemArr[id].clearType=ClearType.SELF,this.lastMoveArr.push(id))}addIdToLastMoveArr(id){this.lastMoveArr.push(id)}addToGrassArr(arr){for(let i=0;i<arr.length;i++)this.needToGrassArr.push(arr[i])}addSinglePropsToArr(id,type){let obj={id:id,type:type};this.singlePropsArr.push(obj)}createNewSpace(id){let item=new Item(id,this.itemArr[id].posX,this.itemArr[id].posY,ItemType.SPACE,1,null);this.itemArr[id]=item,EventHandler.Dispatch(EventName.ADD_ITEM,[item])}addTargetItem(target){this.removeItemArr.push(target)}getColor(id){let color=this.getRandomColor(),rowArr=this.findNextSameColor(id,color),colArr=this.findNextSameColor(id,color,!1),isPlane=this.isPlane(id,color);for(;rowArr.length>=3||colArr.length>=3||isPlane;)color=this.getRandomColor(color),rowArr=this.findNextSameColor(id,color),colArr=this.findNextSameColor(id,color,!1),isPlane=this.isPlane(id,color);return color}getRandomColor(color){let newColor=Math.ceil(Math.random()*GameData.ins.colorNum);if(color)for(;newColor==color;)newColor=Math.ceil(Math.random()*GameData.ins.colorNum);return newColor}findOtherPortal(id){for(let i=0;i<this.backArr.length;i++)if(this.otherArr[i].portalNum==-this.otherArr[id].portalNum)return i;return Log.log("出错了，没有找到对应的传送门"),null}borderHandle(id){this.backArr[id].type!=BackType.DEAD&&this.backArr[id].addBackBoard()}updateStep(step=-1){this._step<=0?this.isGameOver():(-1==step?(this._step--,this.isGuideStep>0&&(this.isGuideStep++,MainGameManager.ins.hideGuide())):this._step=step,EventHandler.Dispatch(EventName.UPDATE_STEP))}updateTarget(){GameData.ins.target.updateTargetNum(this.removeItemArr),GameData.ins.roomArr[this.curRoomId].roomTarget.updateTargetNum(this.removeItemArr),EventHandler.Dispatch(EventName.UPDATE_TARGET_NUM)}isGameOver(){this.gameOver||(GameData.ins.target.isClear()?(EventHandler.Dispatch(EventName.LEVEL_CLEAR,[GameData.ins.levelId]),this.gameOver=!0):0==this._step?(EventHandler.Dispatch(EventName.LEVEL_FAILED),this.gameOver=!0):GameData.ins.roomArr[this.curRoomId].roomTarget.isClear()&&(this.isChanging=!0,EventHandler.Dispatch(EventName.NEXT_ROOM,[this.curRoomId+1])))}stopTween(){Laya.timer.clearAll(this)}}class GameData{constructor(){this.IconW=80*Global.scale,this.IconH=80*Global.scale,this.offsetX=0,this.offsetY=0,this.isSuccess=!0}static get ins(){return null==GameData.instance&&(GameData.instance=new GameData),GameData.instance}get levelId(){return this._levelId}get colorNum(){return this._colorNum}get row(){return this._row}get col(){return this._col}get step(){return this._step}get donutData(){return this._donutData}get target(){return this._target}get roomArr(){return this._roomArr}get boardData(){return this._boardData}init(data){for(let key in data['target']){if(data['target'][key] > 5){data['target'][key] = 5;}}this._levelId=data.levelId,this._row=data.row,this._col=data.col,this._step=data.step,this._target=new LevelTarget,this._roomArr=[],this._boardData={},this._colorNum=data.colorNum,this._colorNum>Global.colorMaxNum&&(this._colorNum=Global.colorMaxNum);let num=9-GameData.ins.col;return this.offsetX=num>=0?num*GameData.ins.IconH/2:0,this._row<10&&(this.offsetY=(10-this._row)*this.IconH/2,Global.boardHeight=396+this.offsetY),this.initDonut(data.donut),this.initTarget(data.target),this.initRoom(data.room),Log.log("房间信息",this._roomArr),Log.log("当前关卡:",this._levelId),this.isSuccess}initDonut(donut){if(null==donut)return Log.log("初始化甜甜圈失败"),void(this.isSuccess=!1);donut.maxNum?this._donutData=new DonutData(donut.maxNum,donut.waitingTime,donut.colArr):this._donutData={}}initTarget(target){if(null==target)return Log.log("初始化目标失败"),void(this.isSuccess=!1);for(let i in target)this._target.addTarget(parseInt(i),target[i])}initRoom(rooms){if(null==rooms)return Log.log("初始化房间失败"),void(this.isSuccess=!1);for(let room of rooms){let roomData=new RoomData,itemArr=room.itemArr;for(let item of itemArr){let itemObj={};itemObj.id=item.id,itemObj.type=null!=item.type?item.type:ItemType.NORMAL,itemObj.hp=null!=item.hp?item.hp:1,itemObj.color=null!=item.color?item.color:null,roomData.itemArr.push(itemObj)}let backArr=room.backArr;for(let back of backArr){let backObj={};backObj.id=back.id,backObj.type=null!=back.type?back.type:BackType.NORMAL,roomData.backArr.push(backObj)}let otherArr=room.otherArr;for(let other of otherArr){let otherObj={};otherObj.id=other.id,otherObj.isTop=null!=other.isTop&&other.isTop,otherObj.isBottom=null!=other.isBottom&&other.isBottom,otherObj.portalNum=null!=other.portalNum?other.portalNum:0,otherObj.guardArr=null!=other.guardArr?other.guardArr:[0,0,0,0],roomData.otherArr.push(otherObj)}for(let i in room.roomTarget)roomData.roomTarget.addTarget(parseInt(i),room.roomTarget[i]);this._roomArr.push(roomData)}}initBoardData(){this._boardData={levelId:GameData.ins.levelId,col:GameData.ins.col,row:GameData.ins.row,colorNum:GameData.ins.colorNum,step:this._step,target:[],room:{itemArr:[],otherArr:[],roomTarget:[]},donutData:{}},this._donutData.maxNum&&(this._boardData.donutData.colArr=[...GameData.ins.donutData.colArr],this._boardData.donutData.count=GameData.ins.donutData.count,this._boardData.donutData.maxNum=GameData.ins.donutData.maxNum,this._boardData.donutData.waitingTime=GameData.ins.donutData.waitingTime);for(let i=0;i<ChessBoard.ins.itemArr.length;i++){let item={};for(let key in ChessBoard.ins.itemArr[i])item.id=ChessBoard.ins.itemArr[i].id,item.type=ChessBoard.ins.itemArr[i].type,item.hp=ChessBoard.ins.itemArr[i].hp,item.color=ChessBoard.ins.itemArr[i].color,item.clearType=ChessBoard.ins.itemArr[i].clearType,item.targetId=ChessBoard.ins.itemArr[i].targetId,item.exchangeable=ChessBoard.ins.itemArr[i].exchangeable,item.movable=ChessBoard.ins.itemArr[i].movable,item.penetrable=ChessBoard.ins.itemArr[i].penetrable;this._boardData.room.itemArr.push(item);let other={};for(let key in ChessBoard.ins.otherArr[i])other.id=ChessBoard.ins.otherArr[i].id,other.isTop=ChessBoard.ins.otherArr[i].isTop,other.isBottom=ChessBoard.ins.otherArr[i].isBottom,other.portalNum=ChessBoard.ins.otherArr[i].portalNum;this._boardData.room.otherArr.push(other)}let targetArr=GameData.ins.target.targetDataArr;for(let i=0;i<targetArr.length;i++){let target={};for(let key in targetArr[i])target[key]=targetArr[i][key];this._boardData.target.push(target)}let roomTargetArr=GameData.ins.roomArr[ChessBoard.ins.curRoomId].roomTarget.targetDataArr;for(let i=0;i<roomTargetArr.length;i++){let roomTarget={};for(let key in roomTargetArr[i])roomTarget[key]=roomTargetArr[i][key];this._boardData.room.roomTarget.push(roomTarget)}JSON.stringify(this._boardData)}}class EffectManager extends Laya.EventDispatcher{constructor(){super(),this.templets=[],this.templetsLoads=[],this.propsTemplets=[],this.propsTempletsLoads=[],this.total=0,this.completeNum=0,this.completed=!1,this.loadCallBack=null,this.ballSkeletonArr=[]}static get Instance(){return EffectManager._instance||(EffectManager._instance=new EffectManager)}loadSpineRes(callback){let templetsFile=["chuanghu/Xyx_bk_ps.sk","chuanghu/Xyx_bk_wz.sk","baozi/Xyx_jt_mg.sk","baozi/Xyx_jt_yg.sk","xiangzi/Xyx_gc_mx.sk","xiangzi/Xyx_gc_yx.sk","kuaizi/Xyx_kz_ys.sk","kuaizi/Xyx_kz_ls.sk","WXXYY_eff_putongxiaochu.sk"];for(let i=0,len=templetsFile.length;i<len;i++){let newSpine=new Laya.Templet;newSpine.loadAni(ResConfig.getSpineURL(templetsFile[i])),newSpine.on(Laya.Event.COMPLETE,this,this.parseComplete),newSpine.on(Laya.Event.LOADED,this,()=>{this.templetsLoads[i]=!0}),this.templets[i]=newSpine}let templetsPropsFile=["daoju/rocket/Xyx_hjt_idle.sk","daoju/rocket/Xyx_hjt_play.sk","daoju/bomb/Xyx_yh_idle.sk","daoju/bomb/Xyx_yh_play1.sk","daoju/bomb/Xyx_yh_play2.sk","daoju/ball/Xyx_tl_idle.sk","daoju/ball/Xyx_tl_play1.sk","daoju/ball/Xyx_tl_play2.sk","daoju/plane/Xyx_fz_idle.sk","daoju/plane/Xyx_fz_play1.sk","daoju/plane/Xyx_fz_play2.sk","daoju/baozha/Xyx_bomb1.sk","daoju/baozha/Xyx_bomb2.sk","daoju/baozha/Xyx_bomb3.sk","daoju/baozha/Xyx_bomb4.sk","daoju/baozha/Xyx_bomb5.sk","chuansongmen/Xyx_lm.sk","chuansongmen/Xyx_hm.sk","WXXYY_eff_wuxianjiantou.sk"];for(let i=0,len=templetsPropsFile.length;i<len;i++){let newSpine=new Laya.Templet;newSpine.loadAni(ResConfig.getSpineURL(templetsPropsFile[i])),newSpine.on(Laya.Event.COMPLETE,this,this.parseComplete),newSpine.on(Laya.Event.LOADED,this,()=>{this.propsTempletsLoads[i]=!0}),this.propsTemplets[i]=newSpine}this.total=templetsFile.length+templetsPropsFile.length,this.loadCallBack=callback}parseComplete(){this.completeNum++,this.completeNum==this.total&&(this.completed=!0,Log.log("动效加载完成"),this.loadCallBack&&this.loadCallBack.run())}playEffect(skin,name,x,y){if(0==this.templetsLoads[skin])return;let skeleton0;(skeleton0=this.templets[skin].buildArmature(0)).pos(x,y),skeleton0.scale(Global.scale,Global.scale),skin!=EffectList.kuaizi1&&skin!=EffectList.kuaizi2||skeleton0.playbackRate(1.5),skeleton0.play(name,!1),Laya.stage.addChild(skeleton0),skeleton0.on(Laya.Event.STOPPED,this,()=>{skeleton0.removeSelf(),skeleton0.destroy()})}playPropEffect(skin,x,y,rotation=0,callback){if(0==this.propsTempletsLoads[skin])return;let skeleton0;if((skeleton0=this.propsTemplets[skin].buildArmature(0)).pos(x,y),skeleton0.scale(Global.scale,Global.scale),skin==PropsEffectList.ball_play1)skeleton0.play(0,!0),this.ballSkeletonArr.push(skeleton0);else if(skin==PropsEffectList.ball_play2){if(this.ballSkeletonArr.length>0){this.ballSkeletonArr.shift().removeSelf(),0==this.ballSkeletonArr.length&&(ChessBoard.ins.isPause=!1)}skeleton0.play(0,!1)}else skeleton0.play(0,!1);skeleton0.playbackRate(1.5),skin==PropsEffectList.rocket_play?(90!=rotation&&180!=rotation||(skeleton0.skewY=180),skeleton0.playbackRate(2)):skin==PropsEffectList.plane_play1&&skeleton0.playbackRate(1),skeleton0.rotation=rotation,Laya.stage.addChild(skeleton0),skeleton0.on(Laya.Event.STOPPED,this,()=>{callback&&callback.run(),skeleton0.removeSelf(),skeleton0.destroy()})}playGif(caller,skin,rotation=0){if(0==this.propsTempletsLoads[skin])return;let skeleton0;switch((skeleton0=this.propsTemplets[skin].buildArmature(0)).scale(Global.scale,Global.scale),skin){case PropsEffectList.rukou:skeleton0.pos(GameData.ins.IconW/2,GameData.ins.IconH/2+35*Global.scale);break;case PropsEffectList.chukou:skeleton0.pos(GameData.ins.IconW/2,GameData.ins.IconH/2-35*Global.scale);break;case PropsEffectList.wuxianjiantou:skeleton0.pos(GameData.ins.IconW/2,GameData.ins.IconH/2+GameData.ins.IconH);break;default:skeleton0.pos(GameData.ins.IconW/2,GameData.ins.IconH/2)}skeleton0.rotation=rotation,skeleton0.play(0,!0),caller.addChild(skeleton0)}}var Loader=Laya.Loader;class PrepareRes extends PrepareItem{constructor(){super()}onInit(){super.onInit(),Laya.loader.on(Laya.Event.ERROR,this,this.onLoadError),this.progressHandler.runWith("加载游戏资源"),this._resList=[{url:ResConfig.getAtlasURL("icon.atlas"),type:Loader.ATLAS},{url:ResConfig.getAtlasURL("board.atlas"),type:Loader.ATLAS},{url:ResConfig.getAtlasURL("dlg.atlas"),type:Loader.ATLAS},{url:"dlg/start.png",type:Loader.IMAGE}]}start(){this._resList.length>0?Laya.loader.load(this._resList,Laya.Handler.create(this,this.onLoadComplete),Laya.Handler.create(this,this.onLoadProgress,null,!1)):this.complete(),EffectManager.Instance.loadSpineRes(Laya.Handler.create(this,this.loadGameRes))}dispose(){super.dispose(),Laya.loader.off(Laya.Event.ERROR,this,this.onLoadError)}onLoadComplete(data){data?(MainGameManager.ins.init(),this.complete()):this.errorHandler.runWith("加载游戏资源失败")}onLoadProgress(url,progress){}onLoadError(url){this.progressHandler.runWith(`加载游戏资源失败: ${url}`)}loadGameRes(){Laya.timer.once(200,this,()=>{document.getElementById("LoadBg").style.display="none"});let bigRes=[{url:"board/left.jpg",type:Loader.IMAGE},{url:"board/right.jpg",type:Loader.IMAGE},{url:"board/bg_board.jpg",type:Loader.IMAGE},{url:"dlg/start.png",type:Loader.IMAGE},{url:"dlg/black.png",type:Loader.IMAGE},{url:"dlg/lose.png",type:Loader.IMAGE},{url:"dlg/tips.png",type:Loader.IMAGE},{url:"dlg/win.png",type:Loader.IMAGE},{url:"dlg/bubble.jpg",type:Loader.IMAGE},{url:"dlg/spine/Xyx_lose_snow.png",type:Loader.IMAGE},{url:"dlg/spine/Xyx_lose_snow.sk",type:Loader.BUFFER},{url:"dlg/spine/Xyx_victory_fireworks.png",type:Loader.IMAGE},{url:"dlg/spine/Xyx_victory_fireworks.sk",type:Loader.BUFFER},{url:ResConfig.getSoundURL("eliminate.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("fall.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("initProp.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("rocket.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("bomb.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("ball.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("plane.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("locked1.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("suger1.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("suger2.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("box2.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("box1.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("gamewin.mp3"),type:Loader.SOUND},{url:ResConfig.getSoundURL("gamelose.mp3"),type:Loader.SOUND}];Laya.loader.load(bigRes,Laya.Handler.create(this,this.onLoadGameResComplete))}onLoadGameResComplete(){}}class Prepare{constructor(){}init(){}start(){this.reset(),this.add(new PrepareUrl),this.add(new PrepareRes),this.begin()}reset(){this._total=0,this._progress=0,this._items=[],this._started=[]}begin(){const item=this._items.shift();item?(this._started.push(item),item.init(),item.start()):this.PrepareFinish()}add(item){this._items.push(item),item.completeHandler=Laya.Handler.create(this,this.onPrepareItemComplete,[item]),item.progressHandler=Laya.Handler.create(this,this.onPrepareItemProgress,[item],!1),item.errorHandler=Laya.Handler.create(this,this.onPrepareItemError,[item],!1)}addHead(item){this._items.unshift(item),item.completeHandler=Laya.Handler.create(this,this.onPrepareItemComplete,[item]),item.progressHandler=Laya.Handler.create(this,this.onPrepareItemProgress,[item],!1),item.errorHandler=Laya.Handler.create(this,this.onPrepareItemError,[item],!1)}onPrepareItemComplete(item){this.begin(),item.dispose()}onPrepareItemProgress(item,txt){}onPrepareItemError(item,txtError){}PrepareFinish(){this.doFinished()}doFinished(){this.clear()}clear(){this._items=null,this._started=null}}new class{constructor(){this.jsFix(),window.Laya3D?Laya3D.init(GameConfig.width,GameConfig.height):Laya.init(GameConfig.width,GameConfig.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=GameConfig.scaleMode,Laya.stage.screenMode=GameConfig.screenMode,Laya.stage.alignV=GameConfig.alignV,Laya.stage.alignH=GameConfig.alignH,Laya.URL.exportSceneToJson=GameConfig.exportSceneToJson,(GameConfig.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),GameConfig.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),GameConfig.stat&&Laya.Stat.show(),Laya.alertGlobalError=!0,Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Global.isOffline||(Laya.URL.basePath=Global.domain),Laya.Browser.window.history&&Laya.Browser.window.history.pushState&&Laya.Browser.window.addEventListener("popstate",function(){Laya.Browser.window.history.pushState("forward",null,"#"),Laya.Browser.window.history.forward(1)}),Laya.Browser.window.history.pushState("forward",null,"#"),Laya.Browser.window.history.forward(1),this.onConfigLoaded(),this.adapter(),Laya.stage.on(Laya.Event.VISIBILITY_CHANGE,this,this.onVisibilityChange)}onConfigLoaded(){this._prepare=new Prepare,this._prepare.init(),this._prepare.start()}adapter(){Laya.stage.screenMode=Laya.Stage.SCREEN_NONE,Laya.Browser.onPC?Laya.stage.scaleMode=Laya.Stage.SCALE_SHOWALL:(Laya.Browser.onAndroid||Laya.Browser.onIPhone)&&(Laya.stage.scaleMode=Laya.Stage.SCALE_FIXED_WIDTH,Laya.Browser.clientWidth,Laya.Browser.pixelRatio,Laya.Browser.clientHeight,Laya.Browser.pixelRatio,Laya.timer.once(100,this,()=>{Laya.stage.scaleMode=Laya.Stage.SCALE_FIXED_WIDTH})),Laya.stage.alignV=Laya.Stage.ALIGN_MIDDLE,Laya.stage.alignH=Laya.Stage.ALIGN_CENTER}onVisibilityChange(){this.checkVisibilityChange()}getPage(){var hidden,state,visibilityChange;let document=Laya.Browser.window.document;return void 0!==document.hidden?(hidden="hidden",visibilityChange="visibilitychange",state="visibilityState"):void 0!==document.mozHidden?(hidden="mozHidden",visibilityChange="mozvisibilitychange",state="mozVisibilityState"):void 0!==document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange",state="msVisibilityState"):void 0!==document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange",state="webkitVisibilityState"),{hidden:hidden,visibilityChange:visibilityChange,state:state}}checkVisibilityChange(){let page=this.getPage();"hidden"==Laya.Browser.window.document[page.state]?EventHandler.Dispatch(EventName.E_Visibility_Background):EventHandler.Dispatch(EventName.E_Visibility_Foreground)}jsFix(){Math.log2||(Math.log2=function(x){return Math.log(x)*Math.LOG2E})}}}();